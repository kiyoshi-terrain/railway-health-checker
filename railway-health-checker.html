<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自動健全度評価システム - ジェイアール総研エンジニアリング</title>
    <style>
        /* ⭐ ここに追加！！ */
        :root {
            /* JRSEコーポレートカラー */
            --jrse-primary: #006838;
            --jrse-primary-dark: #004d40;
            --jrse-primary-light: #4caf50;
            --jrse-accent: #81c784;
            
            /* ダークモード基調色 */
            --bg-dark: #0a0f0d;
            --bg-card: #1a1f1e;
            --bg-card-hover: #232928;
            --text-primary: #e8f5e9;
            --text-secondary: #a5d6a7;
            --text-muted: #81c784;
            
            /* ステータスカラー */
            --status-safe: #4caf50;
            --status-warning: #ff9800;
            --status-danger: #f44336;
            --status-critical: #d32f2f;
        }
                
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* bodyは軽めのダークグラデーション */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ヘッダーは高級感のあるグリーングラデーション */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(0,104,56,0.9) 0%, rgba(76,175,80,0.9) 100%);
            backdrop-filter: blur(10px);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
            letter-spacing: 0.05em;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            min-height: calc(100vh - 200px);
        }
        
        .input-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-y: auto;
        }

        /* カードは半透明のダークガラス風 */
        .input-panel, .result-card {
            background: rgba(30, 30, 45, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        /* ホバー時に光る */
        .input-panel:hover, .result-card:hover {
            border-color: rgba(76, 175, 80, 0.6);
            box-shadow: 0 8px 32px rgba(76, 175, 80, 0.2);
        }        
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2a5298;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #2a5298;
        }

        /* 入力フィールドもダークに */
        .input-group input {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(76, 175, 80, 0.3);
            color: #e0e0e0;
        }
        
        .input-group input:focus {
            border-color: #4caf50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }        
        
        .coord-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .analyze-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);  /* ⭐ この行だけ変更 */
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);  /* ⭐ この行を追加 */
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }
        
        .analyze-button:hover {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
        }
        
        .analyze-button:active {
            transform: translateY(0);
        }
        
        .results-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .result-card {
    background: #1a1f1e;  /* ダークグレー */
    border: 1px solid rgba(76, 175, 80, 0.2);
    color: #e8f5e9;  /* 文字を明るく */
    /* 他はそのまま */
}
        
        .result-card h3 {
            color: #2a5298;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .health-grade {
            text-align: center;
            padding: 20px;
        }
        
        .grade-circle {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 72px;
            font-weight: bold;
            color: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .grade-A { background: linear-gradient(135deg, #4CAF50, #45a049); }
        .grade-B { background: linear-gradient(135deg, #FFC107, #ff9800); }
        .grade-C { background: linear-gradient(135deg, #FF9800, #f57c00); }
        .grade-D { background: linear-gradient(135deg, #f44336, #d32f2f); }
        
        .cross-section {
            height: 100%;
            position: relative;
        }
        
        #crossSectionCanvas {
            width: 100%;
            height: 100%;
        }
        
        .structure-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .info-item {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
        }
        
        .info-item .label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-item .value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .risk-list {
            list-style: none;
        }
        
        .risk-list li {
            padding: 10px;
            margin-bottom: 8px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
        }
        
        .recommendation-list {
            list-style: none;
        }
        
        .recommendation-list li {
            padding: 8px 12px;
            margin-bottom: 6px;
            background: #e3f2fd;
            border-radius: 4px;
            font-size: 0.95em;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2a5298;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .terrain-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .terrain-item {
            background: #e8f5e9;
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .terrain-label {
            font-size: 0.9em;
            color: #666;
        }
        
        .terrain-value {
            font-weight: bold;
            color: #2e7d32;
        }
        
        .geology-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .geology-item {
            background: #fff3e0;
            padding: 10px 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .geology-label {
            font-size: 0.9em;
            color: #666;
        }
        
        .geology-value {
            font-weight: bold;
            color: #e65100;
            font-size: 0.95em;
        }
        
        .risk-high {
            color: #d32f2f !important;
        }
        
        .risk-medium {
            color: #f57c00 !important;
        }
        
        .risk-low {
            color: #388e3c !important;
        }

        /* タイトルとラベルの色調整 */
        .input-group label {
            color: #4caf50;
        }
        
        .result-card h3 {
            color: #4caf50;
        }
        
        .info-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .info-item .label {
            color: #81c784;
        }
        
        .info-item .value {
            color: #e0e0e0;
        }
        /* ⭐ みくの可愛いアニメーション集！ */
        
        /* 1. ボタンのキラキラアニメーション */
        .analyze-button {
            position: relative;
            overflow: hidden;
        }
        
        .analyze-button::after {
            content: '✨';
            position: absolute;
            top: -20px;
            left: -20px;
            font-size: 20px;
            animation: sparkle 3s linear infinite;
            pointer-events: none;
        }
        
        @keyframes sparkle {
            to {
                top: 100%;
                left: 100%;
                transform: rotate(360deg);
            }
        }
        
        /* 2. 健全度グレードのパルス */
        .grade-circle {
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            }
            50% { 
                transform: scale(1.05); 
                box-shadow: 0 8px 30px rgba(76, 175, 80, 0.4);
            }
        }
        
        /* 3. 入力フィールドの虹色フォーカス */
        @keyframes rainbowBorder {
            0% { border-color: #4caf50; }
            25% { border-color: #2196F3; }
            50% { border-color: #9c27b0; }
            75% { border-color: #ff9800; }
            100% { border-color: #4caf50; }
        }
        
        .input-group input:focus {
            animation: rainbowBorder 4s linear infinite;
        }
        
        /* 4. カラフルなローディングスピナー */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4caf50;
            border-right: 4px solid #2196F3;
            border-bottom: 4px solid #ff9800;
            border-left: 4px solid #e91e63;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite, colorRotate 2s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes colorRotate {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        /* 5. カードのホバーエフェクト強化 */
        .result-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .result-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 
                0 12px 40px rgba(76, 175, 80, 0.3),
                0 0 80px rgba(76, 175, 80, 0.1);
        }
        
        /* 6. タイトルのグラデーションアニメーション */
        @keyframes shine {
            to { background-position: 200% center; }
        }
        
        .gradient-text {
            background: linear-gradient(90deg, #4caf50, #81c784, #a5d6a7, #81c784, #4caf50);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 5s linear infinite;
        }
        
        /* 7. Phase解析ボタンの特別エフェクト */
        button[onclick*="Geomorphology"], 
        button[onclick*="Catchment"] {
            position: relative;
            overflow: hidden;
        }
        
        button[onclick*="Geomorphology"]::before,
        button[onclick*="Catchment"]::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: slideShine 3s infinite;
        }
        
        @keyframes slideShine {
            to { left: 100%; }
        }        
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>解析中...</p>
        </div>
    </div>
    
    <div class="container">
        <!-- ⭐ 横並びレイアウトに戻す！ -->
        <div style="margin-bottom: 30px; display: flex; align-items: center;">
            <!-- SVGロゴ（左側） -->
            <svg width="150" height="80" viewBox="0 0 250 120" style="flex-shrink: 0; filter: drop-shadow(3px 3px 6px rgba(0,104,56,0.3));">
                <!-- グラデーション定義 -->
                <defs>
                    <linearGradient id="jrseGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#4caf50;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#006838;stop-opacity:1" />
                    </linearGradient>
                </defs>
                
                <!-- JRSEロゴ（グラデーション） -->
                <text x="125" y="50" font-family="Arial Black, sans-serif" font-size="60" font-weight="900" fill="url(#jrseGrad)" text-anchor="middle">JRSE</text>
                
                <!-- サブテキスト（見やすく！） -->
                <text x="125" y="75" font-family="Arial, sans-serif" font-size="16" fill="#006838" font-weight="600" text-anchor="middle">JR SOKEN</text>
                <text x="125" y="92" font-family="Arial, sans-serif" font-size="16" fill="#006838" font-weight="600" text-anchor="middle">ENGINEERING</text>
                <text x="125" y="109" font-family="Arial, sans-serif" font-size="16" fill="#006838" font-weight="600" text-anchor="middle">CO., LTD.</text>
            </svg>
            
            <!-- タイトルテキスト（健全度カードに合わせて左寄せ！） -->
            <div style="flex: 1; text-align: left; margin-left: 300px;">
                <h1 class="gradient-text" style="
                    font-size: 2.5em; 
                    font-weight: 300; 
                    margin: 0;
                    line-height: 1.2;
                ">
                    自動健全度評価システム
                </h1>
                <p style="
                    color: #a5d6a7; 
                    font-size: 1.1em; 
                    margin: 5px 0 0 0;
                    line-height: 1.2;
                ">
                    Advanced Railway Infrastructure Assessment System
                </p>
            </div>
        </div>
        
        <div class="main-grid">
            <div class="input-panel">
                <h2>📍 評価地点の設定</h2>
                
                <div class="input-group">
                    <label>評価地点（線路中心）</label>
                    <div class="coord-inputs">
                        <input type="number" id="latitude" placeholder="緯度" value="35.2323" step="0.0001">
                        <input type="number" id="longitude" placeholder="経度" value="139.0209" step="0.0001">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>前の線路点（線路方向計算用）</label>
                    <div class="coord-inputs">
                        <input type="number" id="prevLat" placeholder="緯度" value="35.2320" step="0.0001">
                        <input type="number" id="prevLon" placeholder="経度" value="139.0205" step="0.0001">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>次の線路点</label>
                    <div class="coord-inputs">
                        <input type="number" id="nextLat" placeholder="緯度" value="35.2326" step="0.0001">
                        <input type="number" id="nextLon" placeholder="経度" value="139.0213" step="0.0001">
                    </div>
                </div>
                
                <button class="analyze-button" onclick="analyzeRailway()">
                    🔍 健全度評価を実行
                </button>
                
                <div class="error" id="error"></div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <h3 style="margin-bottom: 10px;">💡 使い方</h3>
                    <p style="font-size: 0.9em; color: #666; line-height: 1.6;">
                        1. 評価したい線路上の座標を入力<br>
                        2. 線路方向計算のため前後の点も入力<br>
                        3. 「健全度評価を実行」をクリック<br>
                        4. 土構造物の種類・健全度・リスクを確認
                    </p>
                </div>
                
                <!-- みく：地図追加部分 -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <h3 style="margin-bottom: 10px;">📍 評価地点確認</h3>
                    <div id="miniMap" style="width: 100%; height: 200px; border-radius: 8px; overflow: hidden; border: 2px solid #e0e0e0;"></div>
                    <p style="font-size: 0.8em; color: #999; margin-top: 5px; text-align: center;">
                        ※ 座標が正しく設定されているか確認できます
                    </p>
                </div>
            </div>             
            
            <div class="results-panel">
                <div class="result-card health-grade">
                    <h3>🏥 健全度評価</h3>
                    <div id="gradeDisplay" style="display: none;">
                        <div class="grade-circle" id="gradeCircle">-</div>
                        <h4 id="healthLevel" style="font-size: 1.5em; margin-bottom: 10px;">-</h4>
                        <p id="healthScore" style="font-size: 1.1em; color: #666;">スコア: -/100</p>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>🏗️ 構造物情報</h3>
                    <div class="structure-info" id="structureInfo">
                        <div class="info-item">
                            <div class="label">構造物タイプ</div>
                            <div class="value" id="structureType">-</div>
                        </div>
                        <div class="info-item">
                            <div class="label">標高</div>
                            <div class="value" id="elevation">-</div>
                        </div>
                        <div class="info-item">
                            <div class="label">集水面積</div>
                            <div class="value" id="catchmentArea">-</div>
                        </div>
                        <div class="info-item">
                            <div class="label">流水パターン</div>
                            <div class="value" id="flowPattern">-</div>
                        </div>
                        <div class="info-item">
                            <div class="label">地質</div>
                            <div class="value" id="geology">-</div>
                        </div>
                        <div class="info-item">
                            <div class="label">線路方向</div>
                            <div class="value" id="trackDirection">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="result-card cross-section">
                    <h3>📊 横断面図</h3>
                    <canvas id="crossSectionCanvas"></canvas>
                    <div class="legend">
                        <div class="legend-item">
                            <div style="width: 20px; height: 10px; background: #1e3c72;"></div>
                            <span>地盤線</span>
                        </div>
                        <div class="legend-item">
                            <div style="width: 20px; height: 10px; background: #f44336;"></div>
                            <span>線路位置</span>
                        </div>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>🏔️ 地形・地質評価</h3>
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #4CAF50; margin-bottom: 10px;">地形特性</h4>
                        <div class="terrain-grid">
                            <div class="terrain-item">
                                <span class="terrain-label">地形分類:</span>
                                <span class="terrain-value" id="terrainType">-</span>
                            </div>
                            <div class="terrain-item">
                                <span class="terrain-label">勾配:</span>
                                <span class="terrain-value" id="terrainSlope">-</span>
                            </div>
                            <div class="terrain-item">
                                <span class="terrain-label">0次谷:</span>
                                <span class="terrain-value" id="zeroOrderBasin">-</span>
                            </div>
                            <div class="terrain-item">
                                <span class="terrain-label">集水収束:</span>
                                <span class="terrain-value" id="convergence">-</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #FF9800; margin-bottom: 10px;">地質特性</h4>
                        <div class="geology-info">
                            <div class="geology-item">
                                <div class="geology-label">岩石種類</div>
                                <div class="geology-value" id="rockType">-</div>
                            </div>
                            <div class="geology-item">
                                <div class="geology-label">地質年代</div>
                                <div class="geology-value" id="geologicalAge">-</div>
                            </div>
                            <div class="geology-item">
                                <div class="geology-label">リスク評価</div>
                                <div class="geology-value" id="geologyRisk">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
                        
            <div class="result-card" style="grid-column: 1 / -1; margin-top: 20px;">
                <h3>🤖 AI統合評価レポート</h3>
                <div id="aiCommentary" style="background: #f0f8ff; padding: 20px; border-radius: 8px; margin-top: 15px;">
                    <div class="loading" id="aiLoading" style="display: none;">
                        <div class="spinner"></div>
                        <p>AI解析中...</p>
                    </div>
                    <div id="aiContent" style="line-height: 1.8; color: #333;">
                        <!-- AIコメントがここに入る -->
                    </div>
                </div>
                            
            <!-- ⭐ Phase 2: 地形コンテキスト分析カード -->
            <div class="result-card" style="grid-column: 1 / -1; margin-top: 20px;">
                <h3>🏔️ 地形コンテキスト分析（Phase 2 試作版）</h3>
                <div id="geomorphology-result" style="
                    background: linear-gradient(145deg, #f0f4ff, #e6ecff);
                    border-radius: 10px;
                    padding: 20px;
                    margin: 15px 0;
                    min-height: 100px;
                    position: relative;
                ">
                    <p style="color: #666; text-align: center;">
                        <i class="fas fa-mountain"></i> 地形分析がまだ実行されていません
                    </p>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="runGeomorphologyAnalysis()" style="
                        width: 100%;
                        padding: 15px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-size: 18px;
                        font-weight: bold;
                        cursor: pointer;
                        transition: transform 0.2s, box-shadow 0.2s;
                    ">
                        🔍 地形分析を実行 ✨
                    </button>
                </div>
            </div>

            <!-- ⭐ Phase 3: 集水地形解析カード（みく追加！） -->
            <div class="result-card" style="grid-column: 1 / -1; margin-top: 20px;">
                <h3>💧 集水地形解析（Phase 3）</h3>
                <div id="catchment-result" style="
                    background: linear-gradient(145deg, #e3f2fd, #bbdefb);
                    border-radius: 10px;
                    padding: 20px;
                    margin: 15px 0;
                    min-height: 100px;
                    position: relative;
                ">
                    <p style="color: #666; text-align: center;">
                        <i class="fas fa-water"></i> 集水地形解析がまだ実行されていません
                    </p>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="runCatchmentAnalysis()" style="
                        width: 100%;
                        padding: 15px;
                        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-size: 18px;
                        font-weight: bold;
                        cursor: pointer;
                        transition: transform 0.2s, box-shadow 0.2s;
                    ">
                        💧 集水地形解析を実行 ✨
                    </button>
                </div>
            </div>            
            
        </div>

                <button onclick="generateAIReport()" class="analyze-button" style="margin-top: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    🤖 詳細解説を生成
                </button>
                <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                    <label>
                        <input type="checkbox" id="useAI" onchange="toggleAIMode()">
                        OpenAI APIを使用
                    </label>
                    <input type="password" id="apiKey" placeholder="APIキー" style="display: none; margin-left: 10px; width: 200px;">
                </div>
            </div>
            
        </div>
    </div>
        
    <!-- ⭐ Phase 2: 地形解析スクリプト -->
    <script src="railway-geomorphology.js"></script>
    
    <!-- ⭐ Phase 3: 集水地形解析スクリプト -->
    <script src="railway-catchment-analysis.js"></script>
    
    
    <script>
        // APIのベースURL
        const API_BASE = 'https://terrain-fsieei60s-kiyoshi-terrains-projects.vercel.app';

        // URLパラメータをチェック（みく：追加部分）
        const urlParams = new URLSearchParams(window.location.search);
        const shouldReturnResult = urlParams.get('returnResult') === 'true';

        // ↓↓↓ みく：AI機能用の設定追加（ここから） ↓↓↓
        
        // AI設定
        const AI_CONFIG = {
            useAPI: false,
            apiKey: '',
            model: 'gpt-3.5-turbo' // または 'gpt-4'
        };
        
        // グローバル変数（評価データ保存用）
        let currentRailwayData = null;
        let currentTerrainData = null;
        
        // 維持管理標準準拠の用語定義
        const MAINTENANCE_STANDARD = {
            // 構造物種別（3.1節準拠）
            structures: {
                cutting: '切土',
                embankment: '盛土',
                sidehill: '片切片盛',
                natural_slope: '自然斜面'
            },
            
            // 健全度判定基準（3.6.2項準拠）
            healthGrades: {
                'S': {
                    description: '健全',
                    detail: '運転保安、旅客および公衆などの安全ならびに列車の定時運行の確保を脅かす、またはそのおそれのある変状等がまったくない。'
                },
                'A': {
                    description: '要注意',
                    detail: '運転保安、旅客および公衆などの安全ならびに列車の定時運行の確保を脅かす変状等はないが、将来、それらに該当する変状等に進展するおそれのあるものがある。'
                },
                'B': {
                    description: '要注意',
                    detail: '将来、健全度Aに該当する変状等に進展するおそれのあるものがある。'
                },
                'C': {
                    description: '要注意',
                    detail: '将来、健全度Bに該当する変状等に進展するおそれのあるものがある。'
                },
                'AA': {
                    description: '要措置',
                    detail: '運転保安、旅客および公衆などの安全ならびに列車の定時運行の確保を脅かす変状等がある。'
                }
            },
            
            // 検査周期（3.4節準拠）
            inspectionCycles: {
                'S': '通常全般検査（2年）',
                'A': '通常全般検査（1年）',
                'B': '通常全般検査（1年）',
                'C': '通常全般検査（1年）',
                'AA': '必要の都度、個別検査および随時検査'
            },
            
            // 措置（3.7節準拠）
            measures: {
                monitoring: '監視',
                maintenance: '補修',
                reinforcement: '補強',
                reconstruction: '改築・取替'
            }
        };
        
        // ↑↑↑ みく：ここまで追加 ↑↑↑        
        
        // DOMContentLoadedで確実に実行（みく：最終版）
        document.addEventListener('DOMContentLoaded', function() {
            // デバッグ用
            console.log('DOMContentLoaded発火！');
            console.log('URLパラメータ:', window.location.search);
            console.log('lat2:', urlParams.get('lat2'));
            console.log('lon2:', urlParams.get('lon2'));
            
            // 3点選択からの座標を受け取る
            if (urlParams.has('lat2') && urlParams.has('lon2')) {
                // 評価地点（中央）
                const latInput = document.getElementById('latitude');
                const lonInput = document.getElementById('longitude');
                
                if (latInput && lonInput) {
                    latInput.value = urlParams.get('lat2');
                    lonInput.value = urlParams.get('lon2');
                    console.log('評価地点設定完了:', latInput.value, lonInput.value);
                }
                
                // 前の線路点
                if (urlParams.has('lat1') && urlParams.has('lon1')) {
                    const prevLatInput = document.getElementById('prevLat');
                    const prevLonInput = document.getElementById('prevLon');
                    if (prevLatInput && prevLonInput) {
                        prevLatInput.value = urlParams.get('lat1');
                        prevLonInput.value = urlParams.get('lon1');
                        console.log('前の点設定完了:', prevLatInput.value, prevLonInput.value);
                    }
                }
                
                // 次の線路点
                if (urlParams.has('lat3') && urlParams.has('lon3')) {
                    const nextLatInput = document.getElementById('nextLat');
                    const nextLonInput = document.getElementById('nextLon');
                    if (nextLatInput && nextLonInput) {
                        nextLatInput.value = urlParams.get('lat3');
                        nextLonInput.value = urlParams.get('lon3');
                        console.log('次の点設定完了:', nextLatInput.value, nextLonInput.value);
                    }
                }
            }
            
            // 初期表示
            initializeDisplay();
                
            // ミニ地図の初期化（みく追加）
            if (urlParams.has('lat2') && urlParams.has('lon2')) {
                const lat = parseFloat(urlParams.get('lat2'));
                const lon = parseFloat(urlParams.get('lon2'));
                
                // OpenStreetMapのiframe埋め込み
                const mapContainer = document.getElementById('miniMap');
                if (mapContainer) {
                    const iframe = document.createElement('iframe');
                    iframe.width = '100%';
                    iframe.height = '200';
                    iframe.frameborder = '0';
                    iframe.scrolling = 'no';
                    iframe.marginheight = '0';
                    iframe.marginwidth = '0';
                    iframe.src = `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.005},${lat-0.005},${lon+0.005},${lat+0.005}&layer=mapnik&marker=${lat},${lon}`;
                    iframe.style.border = 'none';
                    mapContainer.appendChild(iframe);
                }
            }
        });   

        async function analyzeRailway() {
            // 入力値の取得
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            const prevLat = parseFloat(document.getElementById('prevLat').value);
            const prevLon = parseFloat(document.getElementById('prevLon').value);
            const nextLat = parseFloat(document.getElementById('nextLat').value);
            const nextLon = parseFloat(document.getElementById('nextLon').value);
            
            // バリデーション
            if (isNaN(lat) || isNaN(lon)) {
                showError('評価地点の座標を入力してください');
                return;
            }
            
            // ローディング表示
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('error').style.display = 'none';
            
            try {
                // 鉄道評価API呼び出し
                const railwayUrl = `${API_BASE}/api/v1/terrain/analyze?` +
                    `latitude=${lat}&longitude=${lon}&type=railway` +
                    `&prevLat=${prevLat}&prevLon=${prevLon}` +
                    `&nextLat=${nextLat}&nextLon=${nextLon}`;
                
                // 追加の地形詳細データ取得
                const terrainUrl = `${API_BASE}/api/v1/terrain/analyze?` +
                    `latitude=${lat}&longitude=${lon}`;
                
                const [railwayResponse, terrainResponse] = await Promise.all([
                    fetch(railwayUrl),
                    fetch(terrainUrl)
                ]);
                
                const railwayData = await railwayResponse.json();
                const terrainData = await terrainResponse.json();
                
                if (railwayData.success) {
                    displayResults(railwayData.data, terrainData.data);
                } else {
                    showError(railwayData.error || '解析に失敗しました');
                }
            } catch (error) {
                showError('通信エラーが発生しました: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function displayResults(railwayData, terrainData) {
        
            currentRailwayData = railwayData;
            currentTerrainData = terrainData;

            // 健全度表示
            const grade = railwayData.health_assessment.health_grade;
            const gradeCircle = document.getElementById('gradeCircle');
            gradeCircle.textContent = grade;
            gradeCircle.className = `grade-circle grade-${grade}`;
            
            document.getElementById('gradeDisplay').style.display = 'block';
            document.getElementById('healthLevel').textContent = railwayData.health_assessment.health_level;
            document.getElementById('healthScore').textContent = `スコア: ${railwayData.health_assessment.overall_score}/100`;
            
            // 構造物情報
            const structureEl = document.getElementById('structureType');
            const structureType = railwayData.structure_analysis.type;
            const structureDetails = railwayData.structure_analysis.details;
            
            // 構造物タイプの詳細表示
            if (structureType === 'sidehill' && structureDetails) {
                structureEl.textContent = `片切片盛（${structureDetails.cutting_side_ja}・${structureDetails.embankment_side_ja}）`;
                structureEl.style.color = '#f57c00';
            } else {
                structureEl.textContent = railwayData.structure_analysis.type_ja || structureDetails.type_ja;
                if (structureType === 'cutting') {
                    structureEl.style.color = '#d32f2f';
                } else if (structureType === 'embankment') {
                    structureEl.style.color = '#388e3c';
                } else {
                    structureEl.style.color = '#666';
                }
            }
            
            document.getElementById('elevation').textContent = railwayData.location.elevation;
            document.getElementById('catchmentArea').textContent = railwayData.drainage_impact.catchment_area;
            document.getElementById('flowPattern').textContent = railwayData.drainage_impact.impact_pattern;
            document.getElementById('geology').textContent = railwayData.geology_assessment.rock_type;
            document.getElementById('trackDirection').textContent = railwayData.location.track_direction;
            
            // 地形特性（terrainDataから）
            if (terrainData) {
                const terrainFeatures = terrainData.terrain_features;
                document.getElementById('terrainType').textContent = 
                    terrainFeatures.terrain_classification.primary_type || '-';
                
                // 勾配の計算（仮想的に）
                const slope = railwayData.drainage_impact.flow_direction === '平坦地' ? '緩傾斜' : '急傾斜';
                document.getElementById('terrainSlope').textContent = slope;
                
                // 0次谷の有無
                const hasZeroOrder = railwayData.drainage_impact.has_zero_order_basin;
                const zeroOrderEl = document.getElementById('zeroOrderBasin');
                zeroOrderEl.textContent = hasZeroOrder ? '検出' : 'なし';
                zeroOrderEl.className = hasZeroOrder ? 'terrain-value risk-high' : 'terrain-value';
                
                // 集水収束
                const convergence = railwayData.drainage_impact.impact_score > 70 ? '強' : 
                                  railwayData.drainage_impact.impact_score > 40 ? '中' : '弱';
                document.getElementById('convergence').textContent = convergence;
                
                // 地質詳細
                if (terrainData.geology_data && terrainData.geology_data.available) {
                    const geoInfo = terrainData.geology_data.geology_info;
                    document.getElementById('rockType').textContent = geoInfo.rock_type_ja;
                    document.getElementById('geologicalAge').textContent = geoInfo.formation_age_ja;
                } else {
                    document.getElementById('rockType').textContent = railwayData.geology_assessment.rock_type;
                    document.getElementById('geologicalAge').textContent = '不明';
                }
                
                // 地質リスク
                const geoRiskEl = document.getElementById('geologyRisk');
                const geoRisk = railwayData.geology_assessment.risk_level;
                geoRiskEl.textContent = geoRisk;
                geoRiskEl.className = `geology-value risk-${geoRisk}`;
            }            
            
            // 横断面図の描画
            drawCrossSection(railwayData.structure_analysis.cross_section, railwayData.structure_analysis);
             
            // 結果を親ウィンドウに送信（みく：追加部分）
            if (shouldReturnResult && window.opener) {
                const resultData = {
                    type: 'healthCheckResult',
                    result: {
                        latitude: parseFloat(document.getElementById('latitude').value),
                        longitude: parseFloat(document.getElementById('longitude').value),
                        health_grade: railwayData.health_assessment.health_grade,
                        health_level: railwayData.health_assessment.health_level,
                        overall_score: railwayData.health_assessment.overall_score,
                        structure_type: railwayData.structure_analysis.type,
                        structure_type_ja: railwayData.structure_analysis.type_ja || railwayData.structure_analysis.details?.type_ja,
                        main_risks: railwayData.health_assessment.main_risks,
                        monitoring_points: railwayData.recommendations.monitoring_points
                    }
                };
                window.opener.postMessage(resultData, '*');
            }
        }
        
        // 【修正版】横断面図の描画関数
        function drawCrossSection(crossSection, structureInfo) {
            const canvas = document.getElementById('crossSectionCanvas');
            const ctx = canvas.getContext('2d');
            
            // キャンバスサイズ設定
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // データの準備
            const points = crossSection;
            const padding = 50;
            const width = canvas.width - padding * 2;
            const height = canvas.height - padding * 2;
            
            // 最大・最小値の取得
            const elevations = points.map(p => p.elevation);
            const minElev = Math.min(...elevations);
            const maxElev = Math.max(...elevations);
            const elevRange = maxElev - minElev;
            
            // きりの良い数値に調整
            const elevStep = elevRange > 50 ? 10 : elevRange > 20 ? 5 : 2;
            const minElevGrid = Math.floor(minElev / elevStep) * elevStep;
            const maxElevGrid = Math.ceil(maxElev / elevStep) * elevStep;
            
            // スケール計算
            const xScale = width / 40; // -20m to +20m
            const yScale = height / (maxElevGrid - minElevGrid);
            
            // 背景
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 構造物タイプに応じた背景色（片切片盛の場合）
            if (structureInfo.type === 'sidehill' && structureInfo.details) {
                const centerX = padding + 20 * xScale;
                
                // 切土側の背景
                ctx.fillStyle = 'rgba(255, 67, 54, 0.1)';
                if (structureInfo.details.cutting_side === 'left') {
                    ctx.fillRect(padding, padding, centerX - padding, height);
                } else {
                    ctx.fillRect(centerX, padding, width - (centerX - padding), height);
                }
                
                // 盛土側の背景
                ctx.fillStyle = 'rgba(76, 175, 80, 0.1)';
                if (structureInfo.details.embankment_side === 'left') {
                    ctx.fillRect(padding, padding, centerX - padding, height);
                } else {
                    ctx.fillRect(centerX, padding, width - (centerX - padding), height);
                }
            } else if (structureInfo.type === 'cutting') {
                // 両切土の背景
                ctx.fillStyle = 'rgba(255, 67, 54, 0.08)';
                ctx.fillRect(padding, padding, width, height);
            } else if (structureInfo.type === 'embankment') {
                // 純盛土の背景
                ctx.fillStyle = 'rgba(76, 175, 80, 0.08)';
                ctx.fillRect(padding, padding, width, height);
            }
            
            // グリッド線と縦軸メモリ
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            
            // 横線（標高）
            for (let elev = minElevGrid; elev <= maxElevGrid; elev += elevStep) {
                const y = canvas.height - padding - (elev - minElevGrid) * yScale;
                
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
                
                ctx.fillStyle = '#666';
                ctx.font = '11px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(elev + 'm', padding - 5, y + 3);
            }
            
            // 縦線（距離）- 5m間隔
            for (let d = -20; d <= 20; d += 5) {
                const x = padding + (d + 20) * xScale;
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, canvas.height - padding);
                ctx.stroke();
                
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(d + 'm', x, canvas.height - padding + 20);
            }
            
            // 軸ラベル
            ctx.save();
            ctx.fillStyle = '#333';
            ctx.font = 'bold 12px Arial';
            
            // Y軸ラベル（標高）
            ctx.translate(15, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.fillText('標高 (m)', 0, 0);
            ctx.restore();
            
            // X軸ラベル（距離）
            ctx.fillStyle = '#333';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('線路中心からの距離 (m)', canvas.width / 2, canvas.height - 5);
            
            // 地形線の描画
            ctx.beginPath();
            ctx.strokeStyle = '#1e3c72';
            ctx.lineWidth = 3;
            
            let firstPoint = true;
            points.forEach((point) => {
                if (point.distance >= -20 && point.distance <= 20) {
                    const x = padding + (point.distance + 20) * xScale;
                    const y = canvas.height - padding - (point.elevation - minElevGrid) * yScale;
                    
                    if (firstPoint) {
                        ctx.moveTo(x, y);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
            });
            ctx.stroke();
            
            // 塗りつぶし
            const endX = padding + 40 * xScale;
            ctx.lineTo(endX, canvas.height - padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.closePath();
            ctx.fillStyle = 'rgba(30, 60, 114, 0.1)';
            ctx.fill();
            
            // 線路位置（中央）
            const centerX = padding + 20 * xScale;
            const centerIdx = 5;
            const centerY = canvas.height - padding - (points[centerIdx].elevation - minElevGrid) * yScale;
            
            // 線路シンボル
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(centerX - 15, centerY);
            ctx.lineTo(centerX + 15, centerY);
            ctx.stroke();
            
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(centerX - 10, centerY - 5);
            ctx.lineTo(centerX - 10, centerY + 5);
            ctx.moveTo(centerX + 10, centerY - 5);
            ctx.lineTo(centerX + 10, centerY + 5);
            ctx.stroke();
            
            // 線路マーカー
            ctx.beginPath();
            ctx.arc(centerX, centerY, 8, 0, 2 * Math.PI);
            ctx.fillStyle = '#f44336';
            ctx.fill();
            ctx.strokeStyle = '#d32f2f';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // 構造物タイプと詳細情報の表示
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            
            // 構造物種別の表示
            const typeJa = structureInfo.details?.type_ja || structureInfo.type_ja || getStructureTypeJa(structureInfo.type);
            ctx.fillText(typeJa, centerX, 40);
            
            // 片切片盛の場合の左右ラベル
            if (structureInfo.type === 'sidehill' && structureInfo.details) {
                ctx.font = 'bold 14px Arial';
                
                // 左側
                const leftX = padding + 10 * xScale;
                if (structureInfo.details.cutting_side === 'left') {
                    ctx.fillStyle = '#d32f2f';
                    ctx.fillText('切土', leftX, 60);
                    ctx.font = '12px Arial';
                    ctx.fillText(`高さ: ${structureInfo.details.cutting_height.toFixed(1)}m`, leftX, 75);
                } else {
                    ctx.fillStyle = '#388e3c';
                    ctx.fillText('盛土', leftX, 60);
                    ctx.font = '12px Arial';
                    ctx.fillText(`高さ: ${structureInfo.details.embankment_height.toFixed(1)}m`, leftX, 75);
                }
                
                // 右側
                const rightX = padding + 30 * xScale;
                if (structureInfo.details.cutting_side === 'right') {
                    ctx.fillStyle = '#d32f2f';
                    ctx.font = 'bold 14px Arial';
                    ctx.fillText('切土', rightX, 60);
                    ctx.font = '12px Arial';
                    ctx.fillText(`高さ: ${structureInfo.details.cutting_height.toFixed(1)}m`, rightX, 75);
                } else {
                    ctx.fillStyle = '#388e3c';
                    ctx.font = 'bold 14px Arial';
                    ctx.fillText('盛土', rightX, 60);
                    ctx.font = '12px Arial';
                    ctx.fillText(`高さ: ${structureInfo.details.embankment_height.toFixed(1)}m`, rightX, 75);
                }
            } else if (structureInfo.type === 'cutting') {
                // 両切土の高さ表示
                ctx.fillStyle = '#d32f2f';
                ctx.font = '14px Arial';
                ctx.fillText(`切土高: ${(structureInfo.details.depth || 0).toFixed(1)}m`, centerX, 60);
                
                // 左右の詳細
                if (structureInfo.details.left_cutting_height !== undefined) {
                    ctx.font = '12px Arial';
                    ctx.fillText(`左: ${structureInfo.details.left_cutting_height.toFixed(1)}m`, 
                                padding + 10 * xScale, 75);
                    ctx.fillText(`右: ${structureInfo.details.right_cutting_height.toFixed(1)}m`, 
                                padding + 30 * xScale, 75);
                }
            } else if (structureInfo.type === 'embankment') {
                // 純盛土の高さ表示
                ctx.fillStyle = '#388e3c';
                ctx.font = '14px Arial';
                ctx.fillText(`盛土高: ${(structureInfo.details.height || 0).toFixed(1)}m`, centerX, 60);
                
                // 左右の詳細
                if (structureInfo.details.left_embankment_height !== undefined) {
                    ctx.font = '12px Arial';
                    ctx.fillText(`左: ${structureInfo.details.left_embankment_height.toFixed(1)}m`, 
                                padding + 10 * xScale, 75);
                    ctx.fillText(`右: ${structureInfo.details.right_embankment_height.toFixed(1)}m`, 
                                padding + 30 * xScale, 75);
                }
            }
            
            // 線路標高の表示
            ctx.fillStyle = '#f44336';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`線路: ${points[5].elevation.toFixed(1)}m`, centerX + 20, centerY + 5);
            
            // 方向ラベル
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('← 左', padding + 5 * xScale, 25);
            ctx.fillText('右 →', padding + 35 * xScale, 25);
            
            // 視点説明
            ctx.fillStyle = '#999';
            ctx.font = '11px Arial';
            ctx.textAlign = 'right';
            ctx.fillText('※起点方から終点方を見た横断面', canvas.width - padding, padding - 5);
            
            // 勾配表示（法面がある場合）
            if (structureInfo.details && structureInfo.details.leftSlope) {
                const leftIdx = 3;
                const leftX = padding + (points[leftIdx].distance + 20) * xScale;
                const leftY = canvas.height - padding - (points[leftIdx].elevation - minElevGrid) * yScale;
                
                ctx.fillStyle = '#666';
                ctx.font = '11px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${structureInfo.details.leftSlope}°`, leftX, leftY - 10);
            }
            
            if (structureInfo.details && structureInfo.details.rightSlope) {
                const rightIdx = 7;
                const rightX = padding + (points[rightIdx].distance + 20) * xScale;
                const rightY = canvas.height - padding - (points[rightIdx].elevation - minElevGrid) * yScale;
                
                ctx.fillStyle = '#666';
                ctx.font = '11px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${structureInfo.details.rightSlope}°`, rightX, rightY - 10);
            }
        }
        
        // 構造物タイプの日本語変換
        function getStructureTypeJa(type) {
            const types = {
                'embankment': '純盛土',
                'cutting': '両切土',
                'sidehill': '片切片盛',
                'at-grade': '平地'
            };
            return types[type] || type;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // 初期表示用のダミーデータ
        function initializeDisplay() {
            const canvas = document.getElementById('crossSectionCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#999';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('評価を実行すると横断面図が表示されます', canvas.width / 2, canvas.height / 2);
        }

        // ========== AI解説機能 ==========
        
        // 1. メインのAI解説生成関数
        async function generateAIReport() {
            if (!currentRailwayData || !currentTerrainData) {
                alert('先に健全度評価を実行してください');
                return;
            }
            
            const aiLoading = document.getElementById('aiLoading');
            const aiContent = document.getElementById('aiContent');
            
            aiLoading.style.display = 'block';
            aiContent.innerHTML = '';
            
            try {
                let commentary;
                
                // API使用モードか判定
                if (AI_CONFIG.useAPI && AI_CONFIG.apiKey) {
                    console.log('OpenAI APIモードで生成');
                    commentary = await generateWithOpenAI(currentRailwayData, currentTerrainData);
                } else {
                    console.log('ルールベースモードで生成');
                    commentary = await generateWithRules(currentRailwayData, currentTerrainData);
                }
                
                aiLoading.style.display = 'none';
                aiContent.innerHTML = commentary;
                
            } catch (error) {
                aiLoading.style.display = 'none';
                aiContent.innerHTML = '<p style="color: red;">解析エラー: ' + error.message + '</p>';
            }
        }
        
        // 2. ルールベース生成（維持管理標準準拠）
        async function generateWithRules(railwayData, terrainData) {
            const structureType = railwayData.structure_analysis.type;
            const structureTypeJa = MAINTENANCE_STANDARD.structures[structureType] || railwayData.structure_analysis.type_ja;
            const healthGrade = railwayData.health_assessment.health_grade;
            const healthInfo = MAINTENANCE_STANDARD.healthGrades[healthGrade];
            
            let html = '<div class="ai-report" style="font-size: 14px; line-height: 1.8;">';
            
            // タイトル
            html += '<h3 style="text-align: center; color: #2a5298; margin-bottom: 20px;">土構造物健全度評価報告書</h3>';
            
            // 1. 基本情報
            html += '<div class="section" style="margin-bottom: 20px;">';
            html += '<h4 style="color: #2a5298; border-bottom: 2px solid #2a5298; padding-bottom: 5px;">1. 評価対象構造物</h4>';
            html += '<table style="width: 100%; margin-top: 10px;">';
            html += `<tr><td style="width: 30%; padding: 5px;">構造物種別：</td><td><strong>${structureTypeJa}</strong></td></tr>`;
            html += `<tr><td style="padding: 5px;">位置：</td><td>北緯 ${railwayData.location.latitude}°、東経 ${railwayData.location.longitude}°</td></tr>`;
            html += `<tr><td style="padding: 5px;">標高：</td><td>${railwayData.location.elevation}</td></tr>`;
            html += '</table>';
            html += '</div>';
            
            // 2. 健全度判定
            html += '<div class="section" style="margin-bottom: 20px;">';
            html += '<h4 style="color: #2a5298; border-bottom: 2px solid #2a5298; padding-bottom: 5px;">2. 健全度判定結果</h4>';
            html += '<div style="background: #f5f5f5; padding: 15px; margin-top: 10px; border-radius: 5px;">';
            html += `<p style="font-size: 18px; margin: 0;">健全度ランク：<span style="font-size: 24px; font-weight: bold; color: ${getGradeColor(healthGrade)};">${healthGrade}</span>（${healthInfo.description}）</p>`;
            html += `<p style="margin: 10px 0 0 0; color: #666;">${healthInfo.detail}</p>`;
            html += '</div>';
            html += '</div>';
            
            // 3. 主な変状
            if (railwayData.health_assessment.main_risks.length > 0) {
                html += '<div class="section" style="margin-bottom: 20px;">';
                html += '<h4 style="color: #2a5298; border-bottom: 2px solid #2a5298; padding-bottom: 5px;">3. 確認された主な変状</h4>';
                html += '<ul style="margin-top: 10px;">';
                railwayData.health_assessment.main_risks.forEach(risk => {
                    html += `<li style="margin-bottom: 5px;">${risk}</li>`;
                });
                html += '</ul>';
                html += '</div>';
            }
            
            // 4. 集水特性評価
            html += '<div class="section" style="margin-bottom: 20px;">';
            html += '<h4 style="color: #2a5298; border-bottom: 2px solid #2a5298; padding-bottom: 5px;">4. 集水特性評価</h4>';
            
            if (railwayData.drainage_impact.has_zero_order_basin) {
                html += '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin: 10px 0;">';
                html += '<strong>⚠️ 0次谷検出</strong><br>';
                html += '地形的に表流水が集中しやすい箇所です。集中豪雨時の局所的な出水に注意が必要です。';
                html += '</div>';
            }
            
            html += `<p>集水面積規模：${railwayData.drainage_impact.catchment_area}</p>`;
            html += `<p>主要集水方向：${railwayData.drainage_impact.impact_pattern}</p>`;
            html += '</div>';
            
            // 5. 維持管理上の留意点
            html += '<div class="section" style="margin-bottom: 20px;">';
            html += '<h4 style="color: #2a5298; border-bottom: 2px solid #2a5298; padding-bottom: 5px;">5. 維持管理上の留意点</h4>';
            html += '<p style="margin-top: 10px;">検査周期：' + MAINTENANCE_STANDARD.inspectionCycles[healthGrade] + '</p>';
            
            // 監視ポイント
            if (railwayData.recommendations.monitoring_points.length > 0) {
                html += '<p style="margin-top: 10px;"><strong>重点監視項目：</strong></p>';
                html += '<ul>';
                railwayData.recommendations.monitoring_points.forEach(point => {
                    html += `<li style="margin-bottom: 5px;">${point}</li>`;
                });
                html += '</ul>';
            }
            html += '</div>';
            
            // 6. 推奨措置
            html += '<div class="section" style="margin-bottom: 20px;">';
            html += '<h4 style="color: #2a5298; border-bottom: 2px solid #2a5298; padding-bottom: 5px;">6. 推奨される措置</h4>';
            
            // 健全度に応じた措置
            if (healthGrade === 'AA') {
                html += '<p style="color: #d32f2f;"><strong>緊急措置が必要です。</strong></p>';
            } else if (healthGrade === 'A' || healthGrade === 'B') {
                html += '<p>計画的な' + MAINTENANCE_STANDARD.measures.maintenance + 'または' + 
                        MAINTENANCE_STANDARD.measures.reinforcement + 'を検討してください。</p>';
            } else if (healthGrade === 'C') {
                html += '<p>継続的な' + MAINTENANCE_STANDARD.measures.monitoring + 'を実施してください。</p>';
            }
            
            html += '</div>';
            
            // 評価日時
            const now = new Date();
            html += '<p style="text-align: right; color: #666; font-size: 12px; margin-top: 30px;">';
            html += `評価実施日時：${now.toLocaleString('ja-JP')}<br>`;
            html += '評価方法：維持管理標準準拠ルールベース';
            html += '</p>';
            
            html += '</div>';
            
            return html;
        }
        
        // 3. OpenAI API版
        async function generateWithOpenAI(railwayData, terrainData) {
            const systemPrompt = `あなたは鉄道土構造物の維持管理専門家です。
鉄道構造物等維持管理標準（土構造物）に完全準拠して評価レポートを作成してください。

使用する用語：
- 構造物種別：切土、盛土、片切片盛、自然斜面
- 健全度：S（健全）、A・B・C（要注意）、AA（要措置）
- 変状種別：付表3-2に準拠
- 措置：監視、補修、補強、改築・取替

レポート形式：
1. 評価対象構造物
2. 健全度判定結果
3. 確認された主な変状
4. 集水特性評価
5. 維持管理上の留意点
6. 推奨される措置`;

            const userPrompt = `以下の評価データから維持管理標準準拠のレポートを生成してください：

構造物：${railwayData.structure_analysis.type_ja}
健全度：${railwayData.health_assessment.health_grade}
スコア：${railwayData.health_assessment.overall_score}/100
位置：${railwayData.location.latitude}, ${railwayData.location.longitude}
標高：${railwayData.location.elevation}

主な変状：
${railwayData.health_assessment.main_risks.join('\n')}

集水特性：
- 0次谷：${railwayData.drainage_impact.has_zero_order_basin ? '検出' : 'なし'}
- 集水面積：${railwayData.drainage_impact.catchment_area}
- 集水パターン：${railwayData.drainage_impact.impact_pattern}

地質：${railwayData.geology_assessment.rock_type}
地質リスク：${railwayData.geology_assessment.risk_level}

監視ポイント：
${railwayData.recommendations.monitoring_points.join('\n')}`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AI_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: AI_CONFIG.model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        temperature: 0.3,
                        max_tokens: 1500
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed: ' + response.statusText);
                }
                
                const data = await response.json();
                let aiResponse = data.choices[0].message.content;
                
                // HTMLフォーマット
                aiResponse = aiResponse.replace(/\n/g, '<br>');
                aiResponse = aiResponse.replace(/##\s*(.+)/g, '<h4 style="color: #2a5298; margin: 15px 0 10px 0;">$1</h4>');
                aiResponse = aiResponse.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                
                // ラッパーとフッター追加
                return `<div class="ai-report" style="font-size: 14px; line-height: 1.8;">
                    ${aiResponse}
                    <p style="text-align: right; color: #666; font-size: 12px; margin-top: 30px;">
                        評価実施日時：${new Date().toLocaleString('ja-JP')}<br>
                        評価方法：OpenAI ${AI_CONFIG.model} (維持管理標準準拠)
                    </p>
                </div>`;
                
            } catch (error) {
                console.error('OpenAI API Error:', error);
                // エラー時はルールベースにフォールバック
                return await generateWithRules(railwayData, terrainData);
            }
        }
        
        // 4. 健全度の色を取得
        function getGradeColor(grade) {
            const colors = {
                'S': '#4CAF50',
                'A': '#FFC107',
                'B': '#FF9800',
                'C': '#f57c00',
                'AA': '#f44336'
            };
            return colors[grade] || '#666';
        }
        
        // 5. UI制御関数
        function toggleAIMode() {
            const useAI = document.getElementById('useAI').checked;
            const apiKeyInput = document.getElementById('apiKey');
            
            if (useAI) {
                apiKeyInput.style.display = 'inline';
                AI_CONFIG.useAPI = true;
            } else {
                apiKeyInput.style.display = 'none';
                AI_CONFIG.useAPI = false;
            }
        }
        
        // ========== AI解説機能ここまで ==========
        
        // Enterキーでも実行
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeRailway();
            }
        });

                // ↓↓↓ みく：これを追加 ↓↓↓
        
        // APIキー入力イベント
        window.addEventListener('DOMContentLoaded', function() {
            const apiKeyInput = document.getElementById('apiKey');
            if (apiKeyInput) {
                apiKeyInput.addEventListener('change', function() {
                    AI_CONFIG.apiKey = this.value;
                });
            }
        });
        
        // ⭐ Phase 2: 地形コンテキスト分析機能
        async function runGeomorphologyAnalysis() {
            console.log('🏔️ 地形分析開始！');
            
            // ⭐ デバッグログ追加！
            console.log('currentRailwayData:', currentRailwayData);
            console.log('currentTerrainData:', currentTerrainData);
            
            if (!currentRailwayData || !currentTerrainData) {
                alert('先に健全度評価を実行してください！');
                return;
            }
            
            const analyzer = new GeomorphologyAnalyzer();
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            
            // ⭐ ここも確認！
            console.log('渡すデータ:', {
                lat: lat,
                lon: lon,
                railwayData: currentRailwayData,
                terrainData: currentTerrainData
            });
            
            const resultDiv = document.getElementById('geomorphology-result');
            
            // ローディング表示
            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p style="color: #6366f1; font-weight: bold; margin-top: 15px;">
                        🔍 分析中... みくが地形データを解析してるよ！
                    </p>
                </div>
            `;
            
            try {
                // 拡張版のanalyzeContextを呼び出し
                const report = await analyzer.analyzeContext(
                    lat, 
                    lon, 
                    currentRailwayData,  // 既存データを渡す
                    currentTerrainData   // 既存データを渡す
                );
                
                // HTML形式のレポートをそのまま表示
                resultDiv.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 8px;
                        padding: 20px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    ">
                        ${report}
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="
                        background: #fee;
                        border: 1px solid #fcc;
                        border-radius: 8px;
                        padding: 15px;
                        color: #c33;
                    ">
                        <p><strong>エラーが発生しました 😢</strong></p>
                        <p style="font-size: 14px; margin-top: 5px;">
                            ${error.message}
                        </p>
                    </div>
                `;
                console.error('地形解析エラー:', error);
            }
        }

        // ⭐ Phase 3: 集水地形解析機能
        async function runCatchmentAnalysis() {
            console.log('💧 集水地形解析開始！');
            
            if (!currentRailwayData || !currentTerrainData) {
                alert('先に健全度評価を実行してください！');
                return;
            }
            
            const analyzer = new CatchmentAnalyzer();
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            
            const resultDiv = document.getElementById('catchment-result');
            
            // ローディング表示
            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p style="color: #2196F3; font-weight: bold; margin-top: 15px;">
                        🔍 解析中... みくが集水地形を分析してるよ！
                    </p>
                </div>
            `;
            
            try {
    // 集水地形解析実行
    const result = await analyzer.analyzeCatchmentFeatures(lat, lon);
    
    // ⭐ デバッグ用：結果の形式を確認！
    console.log('解析結果:', result);
    
    // 結果が正しく返ってきてるかチェック
    if (!result) {
        throw new Error('解析結果が空です');
    }
    
    // 結果表示HTML作成（安全にアクセス）
    let html = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h4 style="color: #1976D2; margin-bottom: 10px;">🏔️ 谷地形検出結果</h4>
                <p><strong>検出谷数:</strong> ${result.valleyFeatures ? result.valleyFeatures.length : 0}箇所</p>
                <p><strong>0次谷:</strong> ${result.hasZeroOrderValley ? '検出あり⚠️' : 'なし'}</p>
                <p><strong>最近接谷:</strong> ${result.nearestValleyDistance ? result.nearestValleyDistance.toFixed(0) : '---'}m</p>
            </div>
            <div>
                <h4 style="color: #1976D2; margin-bottom: 10px;">💧 集水影響評価</h4>
                <p><strong>影響度:</strong> <span style="
                    font-size: 20px; 
                    font-weight: bold; 
                    color: ${result.overallRisk > 70 ? '#d32f2f' : result.overallRisk > 40 ? '#f57c00' : '#388e3c'};
                ">${result.impactLevel || '---'}</span></p>
                <p><strong>スコア:</strong> ${result.overallRisk || 0}/100</p>
                <p><strong>主要集水方向:</strong> ${result.dominantFlowDirection || '---'}</p>
            </div>
        </div>
            
    <!-- ⭐ 影響度スコアの凡例を追加！ -->
    <div style="
        margin-top: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 8px;
        border-left: 4px solid #2196F3;
    ">
        <h5 style="margin: 0 0 10px 0; color: #1976D2;">📊 影響度スコアの見方</h5>
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; text-align: center;">
            <div style="padding: 5px; background: #e8f5e9; border-radius: 4px;">
                <div style="font-weight: bold; color: #388e3c;">0-20</div>
                <div style="font-size: 12px;">極低</div>
            </div>
            <div style="padding: 5px; background: #fff3e0; border-radius: 4px;">
                <div style="font-weight: bold; color: #f57c00;">21-40</div>
                <div style="font-size: 12px;">低</div>
            </div>
            <div style="padding: 5px; background: #fff3e0; border-radius: 4px;">
                <div style="font-weight: bold; color: #f57c00;">41-60</div>
                <div style="font-size: 12px;">中</div>
            </div>
            <div style="padding: 5px; background: #ffebee; border-radius: 4px;">
                <div style="font-weight: bold; color: #d32f2f;">61-80</div>
                <div style="font-size: 12px;">高</div>
            </div>
            <div style="padding: 5px; background: #ffebee; border-radius: 4px;">
                <div style="font-weight: bold; color: #b71c1c;">81-100</div>
                <div style="font-size: 12px;">極高</div>
            </div>
        </div>
        <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">
            ※ 北久里浜駅（都市部）のスコア4は「極低」で妥当です
        </p>
    </div>
    `;
                
                // 推奨事項があれば表示
                if (result.recommendations && result.recommendations.length > 0) {
                    html += `
                        <div style="margin-top: 20px;">
                            <h4 style="color: #1976D2;">📝 推奨事項</h4>
                            <ul style="margin: 10px 0;">
                    `;
                    result.recommendations.forEach(rec => {
                        html += `<li style="margin-bottom: 5px;">${rec}</li>`;
                    });
                    html += `</ul></div>`;
                }
                
                // 地図表示ボタン
                html += `
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="showCatchmentMap()" style="
                            padding: 10px 30px;
                            background: #1976D2;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                        ">
                            📍 詳細地図を表示
                        </button>
                    </div>
                `;
                
                resultDiv.innerHTML = html;
                
                // 解析結果を保存
                window.currentCatchmentResult = result;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="
                        background: #fee;
                        border: 1px solid #fcc;
                        border-radius: 8px;
                        padding: 15px;
                        color: #c33;
                    ">
                        <p><strong>エラーが発生しました 😢</strong></p>
                        <p style="font-size: 14px; margin-top: 5px;">
                            ${error.message}
                        </p>
                    </div>
                `;
                console.error('集水地形解析エラー:', error);
            }
        }
        
        // 地図表示関数（モーダル版）
        function showCatchmentMap() {
            // みく：後で実装するけん！
            alert('地図表示機能は次のステップで実装するばい！💕');
        }        
        
    </script>
</body>
</html>