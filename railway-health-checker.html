<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå‹•å¥å…¨åº¦è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ  - ã‚¸ã‚§ã‚¤ã‚¢ãƒ¼ãƒ«ç·ç ”ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°</title>
    <style>
        /* â­ ã“ã“ã«è¿½åŠ ï¼ï¼ */
        :root {
            /* JRSEã‚³ãƒ¼ãƒãƒ¬ãƒ¼ãƒˆã‚«ãƒ©ãƒ¼ */
            --jrse-primary: #006838;
            --jrse-primary-dark: #004d40;
            --jrse-primary-light: #4caf50;
            --jrse-accent: #81c784;
            
            /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åŸºèª¿è‰² */
            --bg-dark: #0a0f0d;
            --bg-card: #1a1f1e;
            --bg-card-hover: #232928;
            --text-primary: #e8f5e9;
            --text-secondary: #a5d6a7;
            --text-muted: #81c784;
            
            /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ©ãƒ¼ */
            --status-safe: #4caf50;
            --status-warning: #ff9800;
            --status-danger: #f44336;
            --status-critical: #d32f2f;
        }
                
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* bodyã¯è»½ã‚ã®ãƒ€ãƒ¼ã‚¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¯é«˜ç´šæ„Ÿã®ã‚ã‚‹ã‚°ãƒªãƒ¼ãƒ³ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(0,104,56,0.9) 0%, rgba(76,175,80,0.9) 100%);
            backdrop-filter: blur(10px);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
            letter-spacing: 0.05em;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            min-height: calc(100vh - 200px);
        }
        
        .input-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-y: auto;
        }

        /* ã‚«ãƒ¼ãƒ‰ã¯åŠé€æ˜ã®ãƒ€ãƒ¼ã‚¯ã‚¬ãƒ©ã‚¹é¢¨ */
        .input-panel, .result-card {
            background: rgba(30, 30, 45, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        /* ãƒ›ãƒãƒ¼æ™‚ã«å…‰ã‚‹ */
        .input-panel:hover, .result-card:hover {
            border-color: rgba(76, 175, 80, 0.6);
            box-shadow: 0 8px 32px rgba(76, 175, 80, 0.2);
        }        
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2a5298;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #2a5298;
        }

        /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ãƒ€ãƒ¼ã‚¯ã« */
        .input-group input {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(76, 175, 80, 0.3);
            color: #e0e0e0;
        }
        
        .input-group input:focus {
            border-color: #4caf50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }        
        
        .coord-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .analyze-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);  /* â­ ã“ã®è¡Œã ã‘å¤‰æ›´ */
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);  /* â­ ã“ã®è¡Œã‚’è¿½åŠ  */
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }
        
        .analyze-button:hover {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
        }
        
        .analyze-button:active {
            transform: translateY(0);
        }
        
        .results-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .result-card {
    background: #1a1f1e;  /* ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ */
    border: 1px solid rgba(76, 175, 80, 0.2);
    color: #e8f5e9;  /* æ–‡å­—ã‚’æ˜ã‚‹ã */
    /* ä»–ã¯ãã®ã¾ã¾ */
}
        
        .result-card h3 {
            color: #2a5298;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .health-grade {
            text-align: center;
            padding: 20px;
        }
        
        .grade-circle {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 72px;
            font-weight: bold;
            color: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .grade-A { background: linear-gradient(135deg, #4CAF50, #45a049); }
        .grade-B { background: linear-gradient(135deg, #FFC107, #ff9800); }
        .grade-C { background: linear-gradient(135deg, #FF9800, #f57c00); }
        .grade-D { background: linear-gradient(135deg, #f44336, #d32f2f); }
        
        .cross-section {
            height: 100%;
            position: relative;
        }
        
        #crossSectionCanvas {
            width: 100%;
            height: 100%;
        }
        
        .structure-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .info-item {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
        }
        
        .info-item .label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-item .value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .risk-list {
            list-style: none;
        }
        
        .risk-list li {
            padding: 10px;
            margin-bottom: 8px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
        }
        
        .recommendation-list {
            list-style: none;
        }
        
        .recommendation-list li {
            padding: 8px 12px;
            margin-bottom: 6px;
            background: #e3f2fd;
            border-radius: 4px;
            font-size: 0.95em;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2a5298;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .terrain-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .terrain-item {
            background: #e8f5e9;
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .terrain-label {
            font-size: 0.9em;
            color: #666;
        }
        
        .terrain-value {
            font-weight: bold;
            color: #2e7d32;
        }
        
        .geology-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .geology-item {
            background: #fff3e0;
            padding: 10px 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .geology-label {
            font-size: 0.9em;
            color: #666;
        }
        
        .geology-value {
            font-weight: bold;
            color: #e65100;
            font-size: 0.95em;
        }
        
        .risk-high {
            color: #d32f2f !important;
        }
        
        .risk-medium {
            color: #f57c00 !important;
        }
        
        .risk-low {
            color: #388e3c !important;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ©ãƒ™ãƒ«ã®è‰²èª¿æ•´ */
        .input-group label {
            color: #4caf50;
        }
        
        .result-card h3 {
            color: #4caf50;
        }
        
        .info-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .info-item .label {
            color: #81c784;
        }
        
        .info-item .value {
            color: #e0e0e0;
        }
        /* â­ ã¿ãã®å¯æ„›ã„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é›†ï¼ */
        
        /* 1. ãƒœã‚¿ãƒ³ã®ã‚­ãƒ©ã‚­ãƒ©ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .analyze-button {
            position: relative;
            overflow: hidden;
        }
        
        .analyze-button::after {
            content: 'âœ¨';
            position: absolute;
            top: -20px;
            left: -20px;
            font-size: 20px;
            animation: sparkle 3s linear infinite;
            pointer-events: none;
        }
        
        @keyframes sparkle {
            to {
                top: 100%;
                left: 100%;
                transform: rotate(360deg);
            }
        }
        
        /* 2. å¥å…¨åº¦ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ãƒ‘ãƒ«ã‚¹ */
        .grade-circle {
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            }
            50% { 
                transform: scale(1.05); 
                box-shadow: 0 8px 30px rgba(76, 175, 80, 0.4);
            }
        }
        
        /* 3. å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è™¹è‰²ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ */
        @keyframes rainbowBorder {
            0% { border-color: #4caf50; }
            25% { border-color: #2196F3; }
            50% { border-color: #9c27b0; }
            75% { border-color: #ff9800; }
            100% { border-color: #4caf50; }
        }
        
        .input-group input:focus {
            animation: rainbowBorder 4s linear infinite;
        }
        
        /* 4. ã‚«ãƒ©ãƒ•ãƒ«ãªãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4caf50;
            border-right: 4px solid #2196F3;
            border-bottom: 4px solid #ff9800;
            border-left: 4px solid #e91e63;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite, colorRotate 2s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes colorRotate {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        /* 5. ã‚«ãƒ¼ãƒ‰ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå¼·åŒ– */
        .result-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .result-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 
                0 12px 40px rgba(76, 175, 80, 0.3),
                0 0 80px rgba(76, 175, 80, 0.1);
        }
        
        /* 6. ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shine {
            to { background-position: 200% center; }
        }
        
        .gradient-text {
            background: linear-gradient(90deg, #4caf50, #81c784, #a5d6a7, #81c784, #4caf50);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 5s linear infinite;
        }
        
        /* 7. Phaseè§£æãƒœã‚¿ãƒ³ã®ç‰¹åˆ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        button[onclick*="Geomorphology"], 
        button[onclick*="Catchment"] {
            position: relative;
            overflow: hidden;
        }
        
        button[onclick*="Geomorphology"]::before,
        button[onclick*="Catchment"]::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: slideShine 3s infinite;
        }
        
        @keyframes slideShine {
            to { left: 100%; }
        }        
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>è§£æä¸­...</p>
        </div>
    </div>
    
    <div class="container">
        <!-- â­ æ¨ªä¸¦ã³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«æˆ»ã™ï¼ -->
        <div style="margin-bottom: 30px; display: flex; align-items: center;">
            <!-- SVGãƒ­ã‚´ï¼ˆå·¦å´ï¼‰ -->
            <svg width="150" height="80" viewBox="0 0 250 120" style="flex-shrink: 0; filter: drop-shadow(3px 3px 6px rgba(0,104,56,0.3));">
                <!-- ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© -->
                <defs>
                    <linearGradient id="jrseGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#4caf50;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#006838;stop-opacity:1" />
                    </linearGradient>
                </defs>
                
                <!-- JRSEãƒ­ã‚´ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ -->
                <text x="125" y="50" font-family="Arial Black, sans-serif" font-size="60" font-weight="900" fill="url(#jrseGrad)" text-anchor="middle">JRSE</text>
                
                <!-- ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆï¼ˆè¦‹ã‚„ã™ãï¼ï¼‰ -->
                <text x="125" y="75" font-family="Arial, sans-serif" font-size="16" fill="#006838" font-weight="600" text-anchor="middle">JR SOKEN</text>
                <text x="125" y="92" font-family="Arial, sans-serif" font-size="16" fill="#006838" font-weight="600" text-anchor="middle">ENGINEERING</text>
                <text x="125" y="109" font-family="Arial, sans-serif" font-size="16" fill="#006838" font-weight="600" text-anchor="middle">CO., LTD.</text>
            </svg>
            
            <!-- ã‚¿ã‚¤ãƒˆãƒ«ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå¥å…¨åº¦ã‚«ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦å·¦å¯„ã›ï¼ï¼‰ -->
            <div style="flex: 1; text-align: left; margin-left: 300px;">
                <h1 class="gradient-text" style="
                    font-size: 2.5em; 
                    font-weight: 300; 
                    margin: 0;
                    line-height: 1.2;
                ">
                    è‡ªå‹•å¥å…¨åº¦è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ 
                </h1>
                <p style="
                    color: #a5d6a7; 
                    font-size: 1.1em; 
                    margin: 5px 0 0 0;
                    line-height: 1.2;
                ">
                    Advanced Railway Infrastructure Assessment System
                </p>
            </div>
        </div>
        
        <div class="main-grid">
            <div class="input-panel">
                <h2>ğŸ“ è©•ä¾¡åœ°ç‚¹ã®è¨­å®š</h2>
                
                <div class="input-group">
                    <label>è©•ä¾¡åœ°ç‚¹ï¼ˆç·šè·¯ä¸­å¿ƒï¼‰</label>
                    <div class="coord-inputs">
                        <input type="number" id="latitude" placeholder="ç·¯åº¦" value="35.2323" step="0.0001">
                        <input type="number" id="longitude" placeholder="çµŒåº¦" value="139.0209" step="0.0001">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>å‰ã®ç·šè·¯ç‚¹ï¼ˆç·šè·¯æ–¹å‘è¨ˆç®—ç”¨ï¼‰</label>
                    <div class="coord-inputs">
                        <input type="number" id="prevLat" placeholder="ç·¯åº¦" value="35.2320" step="0.0001">
                        <input type="number" id="prevLon" placeholder="çµŒåº¦" value="139.0205" step="0.0001">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>æ¬¡ã®ç·šè·¯ç‚¹</label>
                    <div class="coord-inputs">
                        <input type="number" id="nextLat" placeholder="ç·¯åº¦" value="35.2326" step="0.0001">
                        <input type="number" id="nextLon" placeholder="çµŒåº¦" value="139.0213" step="0.0001">
                    </div>
                </div>
                
                <button class="analyze-button" onclick="analyzeRailway()">
                    ğŸ” å¥å…¨åº¦è©•ä¾¡ã‚’å®Ÿè¡Œ
                </button>
                
                <div class="error" id="error"></div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <h3 style="margin-bottom: 10px;">ğŸ’¡ ä½¿ã„æ–¹</h3>
                    <p style="font-size: 0.9em; color: #666; line-height: 1.6;">
                        1. è©•ä¾¡ã—ãŸã„ç·šè·¯ä¸Šã®åº§æ¨™ã‚’å…¥åŠ›<br>
                        2. ç·šè·¯æ–¹å‘è¨ˆç®—ã®ãŸã‚å‰å¾Œã®ç‚¹ã‚‚å…¥åŠ›<br>
                        3. ã€Œå¥å…¨åº¦è©•ä¾¡ã‚’å®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
                        4. åœŸæ§‹é€ ç‰©ã®ç¨®é¡ãƒ»å¥å…¨åº¦ãƒ»ãƒªã‚¹ã‚¯ã‚’ç¢ºèª
                    </p>
                </div>
                
                <!-- ã¿ãï¼šåœ°å›³è¿½åŠ éƒ¨åˆ† -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <h3 style="margin-bottom: 10px;">ğŸ“ è©•ä¾¡åœ°ç‚¹ç¢ºèª</h3>
                    <div id="miniMap" style="width: 100%; height: 200px; border-radius: 8px; overflow: hidden; border: 2px solid #e0e0e0;"></div>
                    <p style="font-size: 0.8em; color: #999; margin-top: 5px; text-align: center;">
                        â€» åº§æ¨™ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã§ãã¾ã™
                    </p>
                </div>
            </div>             
            
            <div class="results-panel">
                <div class="result-card health-grade">
                    <h3>ğŸ¥ å¥å…¨åº¦è©•ä¾¡</h3>
                    <div id="gradeDisplay" style="display: none;">
                        <div class="grade-circle" id="gradeCircle">-</div>
                        <h4 id="healthLevel" style="font-size: 1.5em; margin-bottom: 10px;">-</h4>
                        <p id="healthScore" style="font-size: 1.1em; color: #666;">ã‚¹ã‚³ã‚¢: -/100</p>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>ğŸ—ï¸ æ§‹é€ ç‰©æƒ…å ±</h3>
                    <div class="structure-info" id="structureInfo">
                        <div class="info-item">
                            <div class="label">æ§‹é€ ç‰©ã‚¿ã‚¤ãƒ—</div>
                            <div class="value" id="structureType">-</div>
                        </div>
                        <div class="info-item">
                            <div class="label">æ¨™é«˜</div>
                            <div class="value" id="elevation">-</div>
                        </div>
                        <div class="info-item">
                            <div class="label">é›†æ°´é¢ç©</div>
                            <div class="value" id="catchmentArea">-</div>
                        </div>
                        <div class="info-item">
                            <div class="label">æµæ°´ãƒ‘ã‚¿ãƒ¼ãƒ³</div>
                            <div class="value" id="flowPattern">-</div>
                        </div>
                        <div class="info-item">
                            <div class="label">åœ°è³ª</div>
                            <div class="value" id="geology">-</div>
                        </div>
                        <div class="info-item">
                            <div class="label">ç·šè·¯æ–¹å‘</div>
                            <div class="value" id="trackDirection">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="result-card cross-section">
                    <h3>ğŸ“Š æ¨ªæ–­é¢å›³</h3>
                    <canvas id="crossSectionCanvas"></canvas>
                    <div class="legend">
                        <div class="legend-item">
                            <div style="width: 20px; height: 10px; background: #1e3c72;"></div>
                            <span>åœ°ç›¤ç·š</span>
                        </div>
                        <div class="legend-item">
                            <div style="width: 20px; height: 10px; background: #f44336;"></div>
                            <span>ç·šè·¯ä½ç½®</span>
                        </div>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>ğŸ”ï¸ åœ°å½¢ãƒ»åœ°è³ªè©•ä¾¡</h3>
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #4CAF50; margin-bottom: 10px;">åœ°å½¢ç‰¹æ€§</h4>
                        <div class="terrain-grid">
                            <div class="terrain-item">
                                <span class="terrain-label">åœ°å½¢åˆ†é¡:</span>
                                <span class="terrain-value" id="terrainType">-</span>
                            </div>
                            <div class="terrain-item">
                                <span class="terrain-label">å‹¾é…:</span>
                                <span class="terrain-value" id="terrainSlope">-</span>
                            </div>
                            <div class="terrain-item">
                                <span class="terrain-label">0æ¬¡è°·:</span>
                                <span class="terrain-value" id="zeroOrderBasin">-</span>
                            </div>
                            <div class="terrain-item">
                                <span class="terrain-label">é›†æ°´åæŸ:</span>
                                <span class="terrain-value" id="convergence">-</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #FF9800; margin-bottom: 10px;">åœ°è³ªç‰¹æ€§</h4>
                        <div class="geology-info">
                            <div class="geology-item">
                                <div class="geology-label">å²©çŸ³ç¨®é¡</div>
                                <div class="geology-value" id="rockType">-</div>
                            </div>
                            <div class="geology-item">
                                <div class="geology-label">åœ°è³ªå¹´ä»£</div>
                                <div class="geology-value" id="geologicalAge">-</div>
                            </div>
                            <div class="geology-item">
                                <div class="geology-label">ãƒªã‚¹ã‚¯è©•ä¾¡</div>
                                <div class="geology-value" id="geologyRisk">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
                        
            <div class="result-card" style="grid-column: 1 / -1; margin-top: 20px;">
                <h3>ğŸ¤– AIçµ±åˆè©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                <div id="aiCommentary" style="background: #f0f8ff; padding: 20px; border-radius: 8px; margin-top: 15px;">
                    <div class="loading" id="aiLoading" style="display: none;">
                        <div class="spinner"></div>
                        <p>AIè§£æä¸­...</p>
                    </div>
                    <div id="aiContent" style="line-height: 1.8; color: #333;">
                        <!-- AIã‚³ãƒ¡ãƒ³ãƒˆãŒã“ã“ã«å…¥ã‚‹ -->
                    </div>
                </div>
                            
            <!-- â­ Phase 2: åœ°å½¢ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†æã‚«ãƒ¼ãƒ‰ -->
            <div class="result-card" style="grid-column: 1 / -1; margin-top: 20px;">
                <h3>ğŸ”ï¸ åœ°å½¢ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†æï¼ˆPhase 2 è©¦ä½œç‰ˆï¼‰</h3>
                <div id="geomorphology-result" style="
                    background: linear-gradient(145deg, #f0f4ff, #e6ecff);
                    border-radius: 10px;
                    padding: 20px;
                    margin: 15px 0;
                    min-height: 100px;
                    position: relative;
                ">
                    <p style="color: #666; text-align: center;">
                        <i class="fas fa-mountain"></i> åœ°å½¢åˆ†æãŒã¾ã å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“
                    </p>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="runGeomorphologyAnalysis()" style="
                        width: 100%;
                        padding: 15px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-size: 18px;
                        font-weight: bold;
                        cursor: pointer;
                        transition: transform 0.2s, box-shadow 0.2s;
                    ">
                        ğŸ” åœ°å½¢åˆ†æã‚’å®Ÿè¡Œ âœ¨
                    </button>
                </div>
            </div>

            <!-- â­ Phase 3: é›†æ°´åœ°å½¢è§£æã‚«ãƒ¼ãƒ‰ï¼ˆã¿ãè¿½åŠ ï¼ï¼‰ -->
            <div class="result-card" style="grid-column: 1 / -1; margin-top: 20px;">
                <h3>ğŸ’§ é›†æ°´åœ°å½¢è§£æï¼ˆPhase 3ï¼‰</h3>
                <div id="catchment-result" style="
                    background: linear-gradient(145deg, #e3f2fd, #bbdefb);
                    border-radius: 10px;
                    padding: 20px;
                    margin: 15px 0;
                    min-height: 100px;
                    position: relative;
                ">
                    <p style="color: #666; text-align: center;">
                        <i class="fas fa-water"></i> é›†æ°´åœ°å½¢è§£æãŒã¾ã å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“
                    </p>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="runCatchmentAnalysis()" style="
                        width: 100%;
                        padding: 15px;
                        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-size: 18px;
                        font-weight: bold;
                        cursor: pointer;
                        transition: transform 0.2s, box-shadow 0.2s;
                    ">
                        ğŸ’§ é›†æ°´åœ°å½¢è§£æã‚’å®Ÿè¡Œ âœ¨
                    </button>
                </div>
            </div>            
            
        </div>

                <button onclick="generateAIReport()" class="analyze-button" style="margin-top: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    ğŸ¤– è©³ç´°è§£èª¬ã‚’ç”Ÿæˆ
                </button>
                <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                    <label>
                        <input type="checkbox" id="useAI" onchange="toggleAIMode()">
                        OpenAI APIã‚’ä½¿ç”¨
                    </label>
                    <input type="password" id="apiKey" placeholder="APIã‚­ãƒ¼" style="display: none; margin-left: 10px; width: 200px;">
                </div>
            </div>
            
        </div>
    </div>
        
    <!-- â­ Phase 2: åœ°å½¢è§£æã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="railway-geomorphology.js"></script>
    
    <!-- â­ Phase 3: é›†æ°´åœ°å½¢è§£æã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="railway-catchment-analysis.js"></script>
    
    
    <script>
        // APIã®ãƒ™ãƒ¼ã‚¹URL
        const API_BASE = 'https://terrain-fsieei60s-kiyoshi-terrains-projects.vercel.app';

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã¿ãï¼šè¿½åŠ éƒ¨åˆ†ï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const shouldReturnResult = urlParams.get('returnResult') === 'true';

        // â†“â†“â†“ ã¿ãï¼šAIæ©Ÿèƒ½ç”¨ã®è¨­å®šè¿½åŠ ï¼ˆã“ã“ã‹ã‚‰ï¼‰ â†“â†“â†“
        
        // AIè¨­å®š
        const AI_CONFIG = {
            useAPI: false,
            apiKey: '',
            model: 'gpt-3.5-turbo' // ã¾ãŸã¯ 'gpt-4'
        };
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆè©•ä¾¡ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨ï¼‰
        let currentRailwayData = null;
        let currentTerrainData = null;
        
        // ç¶­æŒç®¡ç†æ¨™æº–æº–æ‹ ã®ç”¨èªå®šç¾©
        const MAINTENANCE_STANDARD = {
            // æ§‹é€ ç‰©ç¨®åˆ¥ï¼ˆ3.1ç¯€æº–æ‹ ï¼‰
            structures: {
                cutting: 'åˆ‡åœŸ',
                embankment: 'ç››åœŸ',
                sidehill: 'ç‰‡åˆ‡ç‰‡ç››',
                natural_slope: 'è‡ªç„¶æ–œé¢'
            },
            
            // å¥å…¨åº¦åˆ¤å®šåŸºæº–ï¼ˆ3.6.2é …æº–æ‹ ï¼‰
            healthGrades: {
                'S': {
                    description: 'å¥å…¨',
                    detail: 'é‹è»¢ä¿å®‰ã€æ—…å®¢ãŠã‚ˆã³å…¬è¡†ãªã©ã®å®‰å…¨ãªã‚‰ã³ã«åˆ—è»Šã®å®šæ™‚é‹è¡Œã®ç¢ºä¿ã‚’è„…ã‹ã™ã€ã¾ãŸã¯ãã®ãŠãã‚Œã®ã‚ã‚‹å¤‰çŠ¶ç­‰ãŒã¾ã£ãŸããªã„ã€‚'
                },
                'A': {
                    description: 'è¦æ³¨æ„',
                    detail: 'é‹è»¢ä¿å®‰ã€æ—…å®¢ãŠã‚ˆã³å…¬è¡†ãªã©ã®å®‰å…¨ãªã‚‰ã³ã«åˆ—è»Šã®å®šæ™‚é‹è¡Œã®ç¢ºä¿ã‚’è„…ã‹ã™å¤‰çŠ¶ç­‰ã¯ãªã„ãŒã€å°†æ¥ã€ãã‚Œã‚‰ã«è©²å½“ã™ã‚‹å¤‰çŠ¶ç­‰ã«é€²å±•ã™ã‚‹ãŠãã‚Œã®ã‚ã‚‹ã‚‚ã®ãŒã‚ã‚‹ã€‚'
                },
                'B': {
                    description: 'è¦æ³¨æ„',
                    detail: 'å°†æ¥ã€å¥å…¨åº¦Aã«è©²å½“ã™ã‚‹å¤‰çŠ¶ç­‰ã«é€²å±•ã™ã‚‹ãŠãã‚Œã®ã‚ã‚‹ã‚‚ã®ãŒã‚ã‚‹ã€‚'
                },
                'C': {
                    description: 'è¦æ³¨æ„',
                    detail: 'å°†æ¥ã€å¥å…¨åº¦Bã«è©²å½“ã™ã‚‹å¤‰çŠ¶ç­‰ã«é€²å±•ã™ã‚‹ãŠãã‚Œã®ã‚ã‚‹ã‚‚ã®ãŒã‚ã‚‹ã€‚'
                },
                'AA': {
                    description: 'è¦æªç½®',
                    detail: 'é‹è»¢ä¿å®‰ã€æ—…å®¢ãŠã‚ˆã³å…¬è¡†ãªã©ã®å®‰å…¨ãªã‚‰ã³ã«åˆ—è»Šã®å®šæ™‚é‹è¡Œã®ç¢ºä¿ã‚’è„…ã‹ã™å¤‰çŠ¶ç­‰ãŒã‚ã‚‹ã€‚'
                }
            },
            
            // æ¤œæŸ»å‘¨æœŸï¼ˆ3.4ç¯€æº–æ‹ ï¼‰
            inspectionCycles: {
                'S': 'é€šå¸¸å…¨èˆ¬æ¤œæŸ»ï¼ˆ2å¹´ï¼‰',
                'A': 'é€šå¸¸å…¨èˆ¬æ¤œæŸ»ï¼ˆ1å¹´ï¼‰',
                'B': 'é€šå¸¸å…¨èˆ¬æ¤œæŸ»ï¼ˆ1å¹´ï¼‰',
                'C': 'é€šå¸¸å…¨èˆ¬æ¤œæŸ»ï¼ˆ1å¹´ï¼‰',
                'AA': 'å¿…è¦ã®éƒ½åº¦ã€å€‹åˆ¥æ¤œæŸ»ãŠã‚ˆã³éšæ™‚æ¤œæŸ»'
            },
            
            // æªç½®ï¼ˆ3.7ç¯€æº–æ‹ ï¼‰
            measures: {
                monitoring: 'ç›£è¦–',
                maintenance: 'è£œä¿®',
                reinforcement: 'è£œå¼·',
                reconstruction: 'æ”¹ç¯‰ãƒ»å–æ›¿'
            }
        };
        
        // â†‘â†‘â†‘ ã¿ãï¼šã“ã“ã¾ã§è¿½åŠ  â†‘â†‘â†‘        
        
        // DOMContentLoadedã§ç¢ºå®Ÿã«å®Ÿè¡Œï¼ˆã¿ãï¼šæœ€çµ‚ç‰ˆï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ‡ãƒãƒƒã‚°ç”¨
            console.log('DOMContentLoadedç™ºç«ï¼');
            console.log('URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', window.location.search);
            console.log('lat2:', urlParams.get('lat2'));
            console.log('lon2:', urlParams.get('lon2'));
            
            // 3ç‚¹é¸æŠã‹ã‚‰ã®åº§æ¨™ã‚’å—ã‘å–ã‚‹
            if (urlParams.has('lat2') && urlParams.has('lon2')) {
                // è©•ä¾¡åœ°ç‚¹ï¼ˆä¸­å¤®ï¼‰
                const latInput = document.getElementById('latitude');
                const lonInput = document.getElementById('longitude');
                
                if (latInput && lonInput) {
                    latInput.value = urlParams.get('lat2');
                    lonInput.value = urlParams.get('lon2');
                    console.log('è©•ä¾¡åœ°ç‚¹è¨­å®šå®Œäº†:', latInput.value, lonInput.value);
                }
                
                // å‰ã®ç·šè·¯ç‚¹
                if (urlParams.has('lat1') && urlParams.has('lon1')) {
                    const prevLatInput = document.getElementById('prevLat');
                    const prevLonInput = document.getElementById('prevLon');
                    if (prevLatInput && prevLonInput) {
                        prevLatInput.value = urlParams.get('lat1');
                        prevLonInput.value = urlParams.get('lon1');
                        console.log('å‰ã®ç‚¹è¨­å®šå®Œäº†:', prevLatInput.value, prevLonInput.value);
                    }
                }
                
                // æ¬¡ã®ç·šè·¯ç‚¹
                if (urlParams.has('lat3') && urlParams.has('lon3')) {
                    const nextLatInput = document.getElementById('nextLat');
                    const nextLonInput = document.getElementById('nextLon');
                    if (nextLatInput && nextLonInput) {
                        nextLatInput.value = urlParams.get('lat3');
                        nextLonInput.value = urlParams.get('lon3');
                        console.log('æ¬¡ã®ç‚¹è¨­å®šå®Œäº†:', nextLatInput.value, nextLonInput.value);
                    }
                }
            }
            
            // åˆæœŸè¡¨ç¤º
            initializeDisplay();
                
            // ãƒŸãƒ‹åœ°å›³ã®åˆæœŸåŒ–ï¼ˆã¿ãè¿½åŠ ï¼‰
            if (urlParams.has('lat2') && urlParams.has('lon2')) {
                const lat = parseFloat(urlParams.get('lat2'));
                const lon = parseFloat(urlParams.get('lon2'));
                
                // OpenStreetMapã®iframeåŸ‹ã‚è¾¼ã¿
                const mapContainer = document.getElementById('miniMap');
                if (mapContainer) {
                    const iframe = document.createElement('iframe');
                    iframe.width = '100%';
                    iframe.height = '200';
                    iframe.frameborder = '0';
                    iframe.scrolling = 'no';
                    iframe.marginheight = '0';
                    iframe.marginwidth = '0';
                    iframe.src = `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.005},${lat-0.005},${lon+0.005},${lat+0.005}&layer=mapnik&marker=${lat},${lon}`;
                    iframe.style.border = 'none';
                    mapContainer.appendChild(iframe);
                }
            }
        });   

        async function analyzeRailway() {
            // å…¥åŠ›å€¤ã®å–å¾—
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            const prevLat = parseFloat(document.getElementById('prevLat').value);
            const prevLon = parseFloat(document.getElementById('prevLon').value);
            const nextLat = parseFloat(document.getElementById('nextLat').value);
            const nextLon = parseFloat(document.getElementById('nextLon').value);
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (isNaN(lat) || isNaN(lon)) {
                showError('è©•ä¾¡åœ°ç‚¹ã®åº§æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('error').style.display = 'none';
            
            try {
                // é‰„é“è©•ä¾¡APIå‘¼ã³å‡ºã—
                const railwayUrl = `${API_BASE}/api/v1/terrain/analyze?` +
                    `latitude=${lat}&longitude=${lon}&type=railway` +
                    `&prevLat=${prevLat}&prevLon=${prevLon}` +
                    `&nextLat=${nextLat}&nextLon=${nextLon}`;
                
                // è¿½åŠ ã®åœ°å½¢è©³ç´°ãƒ‡ãƒ¼ã‚¿å–å¾—
                const terrainUrl = `${API_BASE}/api/v1/terrain/analyze?` +
                    `latitude=${lat}&longitude=${lon}`;
                
                const [railwayResponse, terrainResponse] = await Promise.all([
                    fetch(railwayUrl),
                    fetch(terrainUrl)
                ]);
                
                const railwayData = await railwayResponse.json();
                const terrainData = await terrainResponse.json();
                
                if (railwayData.success) {
                    displayResults(railwayData.data, terrainData.data);
                } else {
                    showError(railwayData.error || 'è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function displayResults(railwayData, terrainData) {
        
            currentRailwayData = railwayData;
            currentTerrainData = terrainData;

            // å¥å…¨åº¦è¡¨ç¤º
            const grade = railwayData.health_assessment.health_grade;
            const gradeCircle = document.getElementById('gradeCircle');
            gradeCircle.textContent = grade;
            gradeCircle.className = `grade-circle grade-${grade}`;
            
            document.getElementById('gradeDisplay').style.display = 'block';
            document.getElementById('healthLevel').textContent = railwayData.health_assessment.health_level;
            document.getElementById('healthScore').textContent = `ã‚¹ã‚³ã‚¢: ${railwayData.health_assessment.overall_score}/100`;
            
            // æ§‹é€ ç‰©æƒ…å ±
            const structureEl = document.getElementById('structureType');
            const structureType = railwayData.structure_analysis.type;
            const structureDetails = railwayData.structure_analysis.details;
            
            // æ§‹é€ ç‰©ã‚¿ã‚¤ãƒ—ã®è©³ç´°è¡¨ç¤º
            if (structureType === 'sidehill' && structureDetails) {
                structureEl.textContent = `ç‰‡åˆ‡ç‰‡ç››ï¼ˆ${structureDetails.cutting_side_ja}ãƒ»${structureDetails.embankment_side_ja}ï¼‰`;
                structureEl.style.color = '#f57c00';
            } else {
                structureEl.textContent = railwayData.structure_analysis.type_ja || structureDetails.type_ja;
                if (structureType === 'cutting') {
                    structureEl.style.color = '#d32f2f';
                } else if (structureType === 'embankment') {
                    structureEl.style.color = '#388e3c';
                } else {
                    structureEl.style.color = '#666';
                }
            }
            
            document.getElementById('elevation').textContent = railwayData.location.elevation;
            document.getElementById('catchmentArea').textContent = railwayData.drainage_impact.catchment_area;
            document.getElementById('flowPattern').textContent = railwayData.drainage_impact.impact_pattern;
            document.getElementById('geology').textContent = railwayData.geology_assessment.rock_type;
            document.getElementById('trackDirection').textContent = railwayData.location.track_direction;
            
            // åœ°å½¢ç‰¹æ€§ï¼ˆterrainDataã‹ã‚‰ï¼‰
            if (terrainData) {
                const terrainFeatures = terrainData.terrain_features;
                document.getElementById('terrainType').textContent = 
                    terrainFeatures.terrain_classification.primary_type || '-';
                
                // å‹¾é…ã®è¨ˆç®—ï¼ˆä»®æƒ³çš„ã«ï¼‰
                const slope = railwayData.drainage_impact.flow_direction === 'å¹³å¦åœ°' ? 'ç·©å‚¾æ–œ' : 'æ€¥å‚¾æ–œ';
                document.getElementById('terrainSlope').textContent = slope;
                
                // 0æ¬¡è°·ã®æœ‰ç„¡
                const hasZeroOrder = railwayData.drainage_impact.has_zero_order_basin;
                const zeroOrderEl = document.getElementById('zeroOrderBasin');
                zeroOrderEl.textContent = hasZeroOrder ? 'æ¤œå‡º' : 'ãªã—';
                zeroOrderEl.className = hasZeroOrder ? 'terrain-value risk-high' : 'terrain-value';
                
                // é›†æ°´åæŸ
                const convergence = railwayData.drainage_impact.impact_score > 70 ? 'å¼·' : 
                                  railwayData.drainage_impact.impact_score > 40 ? 'ä¸­' : 'å¼±';
                document.getElementById('convergence').textContent = convergence;
                
                // åœ°è³ªè©³ç´°
                if (terrainData.geology_data && terrainData.geology_data.available) {
                    const geoInfo = terrainData.geology_data.geology_info;
                    document.getElementById('rockType').textContent = geoInfo.rock_type_ja;
                    document.getElementById('geologicalAge').textContent = geoInfo.formation_age_ja;
                } else {
                    document.getElementById('rockType').textContent = railwayData.geology_assessment.rock_type;
                    document.getElementById('geologicalAge').textContent = 'ä¸æ˜';
                }
                
                // åœ°è³ªãƒªã‚¹ã‚¯
                const geoRiskEl = document.getElementById('geologyRisk');
                const geoRisk = railwayData.geology_assessment.risk_level;
                geoRiskEl.textContent = geoRisk;
                geoRiskEl.className = `geology-value risk-${geoRisk}`;
            }            
            
            // æ¨ªæ–­é¢å›³ã®æç”»
            drawCrossSection(railwayData.structure_analysis.cross_section, railwayData.structure_analysis);
             
            // çµæœã‚’è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«é€ä¿¡ï¼ˆã¿ãï¼šè¿½åŠ éƒ¨åˆ†ï¼‰
            if (shouldReturnResult && window.opener) {
                const resultData = {
                    type: 'healthCheckResult',
                    result: {
                        latitude: parseFloat(document.getElementById('latitude').value),
                        longitude: parseFloat(document.getElementById('longitude').value),
                        health_grade: railwayData.health_assessment.health_grade,
                        health_level: railwayData.health_assessment.health_level,
                        overall_score: railwayData.health_assessment.overall_score,
                        structure_type: railwayData.structure_analysis.type,
                        structure_type_ja: railwayData.structure_analysis.type_ja || railwayData.structure_analysis.details?.type_ja,
                        main_risks: railwayData.health_assessment.main_risks,
                        monitoring_points: railwayData.recommendations.monitoring_points
                    }
                };
                window.opener.postMessage(resultData, '*');
            }
        }
        
        // ã€ä¿®æ­£ç‰ˆã€‘æ¨ªæ–­é¢å›³ã®æç”»é–¢æ•°
        function drawCrossSection(crossSection, structureInfo) {
            const canvas = document.getElementById('crossSectionCanvas');
            const ctx = canvas.getContext('2d');
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºè¨­å®š
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
            const points = crossSection;
            const padding = 50;
            const width = canvas.width - padding * 2;
            const height = canvas.height - padding * 2;
            
            // æœ€å¤§ãƒ»æœ€å°å€¤ã®å–å¾—
            const elevations = points.map(p => p.elevation);
            const minElev = Math.min(...elevations);
            const maxElev = Math.max(...elevations);
            const elevRange = maxElev - minElev;
            
            // ãã‚Šã®è‰¯ã„æ•°å€¤ã«èª¿æ•´
            const elevStep = elevRange > 50 ? 10 : elevRange > 20 ? 5 : 2;
            const minElevGrid = Math.floor(minElev / elevStep) * elevStep;
            const maxElevGrid = Math.ceil(maxElev / elevStep) * elevStep;
            
            // ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—
            const xScale = width / 40; // -20m to +20m
            const yScale = height / (maxElevGrid - minElevGrid);
            
            // èƒŒæ™¯
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // æ§‹é€ ç‰©ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸèƒŒæ™¯è‰²ï¼ˆç‰‡åˆ‡ç‰‡ç››ã®å ´åˆï¼‰
            if (structureInfo.type === 'sidehill' && structureInfo.details) {
                const centerX = padding + 20 * xScale;
                
                // åˆ‡åœŸå´ã®èƒŒæ™¯
                ctx.fillStyle = 'rgba(255, 67, 54, 0.1)';
                if (structureInfo.details.cutting_side === 'left') {
                    ctx.fillRect(padding, padding, centerX - padding, height);
                } else {
                    ctx.fillRect(centerX, padding, width - (centerX - padding), height);
                }
                
                // ç››åœŸå´ã®èƒŒæ™¯
                ctx.fillStyle = 'rgba(76, 175, 80, 0.1)';
                if (structureInfo.details.embankment_side === 'left') {
                    ctx.fillRect(padding, padding, centerX - padding, height);
                } else {
                    ctx.fillRect(centerX, padding, width - (centerX - padding), height);
                }
            } else if (structureInfo.type === 'cutting') {
                // ä¸¡åˆ‡åœŸã®èƒŒæ™¯
                ctx.fillStyle = 'rgba(255, 67, 54, 0.08)';
                ctx.fillRect(padding, padding, width, height);
            } else if (structureInfo.type === 'embankment') {
                // ç´”ç››åœŸã®èƒŒæ™¯
                ctx.fillStyle = 'rgba(76, 175, 80, 0.08)';
                ctx.fillRect(padding, padding, width, height);
            }
            
            // ã‚°ãƒªãƒƒãƒ‰ç·šã¨ç¸¦è»¸ãƒ¡ãƒ¢ãƒª
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            
            // æ¨ªç·šï¼ˆæ¨™é«˜ï¼‰
            for (let elev = minElevGrid; elev <= maxElevGrid; elev += elevStep) {
                const y = canvas.height - padding - (elev - minElevGrid) * yScale;
                
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
                
                ctx.fillStyle = '#666';
                ctx.font = '11px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(elev + 'm', padding - 5, y + 3);
            }
            
            // ç¸¦ç·šï¼ˆè·é›¢ï¼‰- 5mé–“éš”
            for (let d = -20; d <= 20; d += 5) {
                const x = padding + (d + 20) * xScale;
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, canvas.height - padding);
                ctx.stroke();
                
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(d + 'm', x, canvas.height - padding + 20);
            }
            
            // è»¸ãƒ©ãƒ™ãƒ«
            ctx.save();
            ctx.fillStyle = '#333';
            ctx.font = 'bold 12px Arial';
            
            // Yè»¸ãƒ©ãƒ™ãƒ«ï¼ˆæ¨™é«˜ï¼‰
            ctx.translate(15, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.fillText('æ¨™é«˜ (m)', 0, 0);
            ctx.restore();
            
            // Xè»¸ãƒ©ãƒ™ãƒ«ï¼ˆè·é›¢ï¼‰
            ctx.fillStyle = '#333';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ç·šè·¯ä¸­å¿ƒã‹ã‚‰ã®è·é›¢ (m)', canvas.width / 2, canvas.height - 5);
            
            // åœ°å½¢ç·šã®æç”»
            ctx.beginPath();
            ctx.strokeStyle = '#1e3c72';
            ctx.lineWidth = 3;
            
            let firstPoint = true;
            points.forEach((point) => {
                if (point.distance >= -20 && point.distance <= 20) {
                    const x = padding + (point.distance + 20) * xScale;
                    const y = canvas.height - padding - (point.elevation - minElevGrid) * yScale;
                    
                    if (firstPoint) {
                        ctx.moveTo(x, y);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
            });
            ctx.stroke();
            
            // å¡—ã‚Šã¤ã¶ã—
            const endX = padding + 40 * xScale;
            ctx.lineTo(endX, canvas.height - padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.closePath();
            ctx.fillStyle = 'rgba(30, 60, 114, 0.1)';
            ctx.fill();
            
            // ç·šè·¯ä½ç½®ï¼ˆä¸­å¤®ï¼‰
            const centerX = padding + 20 * xScale;
            const centerIdx = 5;
            const centerY = canvas.height - padding - (points[centerIdx].elevation - minElevGrid) * yScale;
            
            // ç·šè·¯ã‚·ãƒ³ãƒœãƒ«
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(centerX - 15, centerY);
            ctx.lineTo(centerX + 15, centerY);
            ctx.stroke();
            
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(centerX - 10, centerY - 5);
            ctx.lineTo(centerX - 10, centerY + 5);
            ctx.moveTo(centerX + 10, centerY - 5);
            ctx.lineTo(centerX + 10, centerY + 5);
            ctx.stroke();
            
            // ç·šè·¯ãƒãƒ¼ã‚«ãƒ¼
            ctx.beginPath();
            ctx.arc(centerX, centerY, 8, 0, 2 * Math.PI);
            ctx.fillStyle = '#f44336';
            ctx.fill();
            ctx.strokeStyle = '#d32f2f';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // æ§‹é€ ç‰©ã‚¿ã‚¤ãƒ—ã¨è©³ç´°æƒ…å ±ã®è¡¨ç¤º
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            
            // æ§‹é€ ç‰©ç¨®åˆ¥ã®è¡¨ç¤º
            const typeJa = structureInfo.details?.type_ja || structureInfo.type_ja || getStructureTypeJa(structureInfo.type);
            ctx.fillText(typeJa, centerX, 40);
            
            // ç‰‡åˆ‡ç‰‡ç››ã®å ´åˆã®å·¦å³ãƒ©ãƒ™ãƒ«
            if (structureInfo.type === 'sidehill' && structureInfo.details) {
                ctx.font = 'bold 14px Arial';
                
                // å·¦å´
                const leftX = padding + 10 * xScale;
                if (structureInfo.details.cutting_side === 'left') {
                    ctx.fillStyle = '#d32f2f';
                    ctx.fillText('åˆ‡åœŸ', leftX, 60);
                    ctx.font = '12px Arial';
                    ctx.fillText(`é«˜ã•: ${structureInfo.details.cutting_height.toFixed(1)}m`, leftX, 75);
                } else {
                    ctx.fillStyle = '#388e3c';
                    ctx.fillText('ç››åœŸ', leftX, 60);
                    ctx.font = '12px Arial';
                    ctx.fillText(`é«˜ã•: ${structureInfo.details.embankment_height.toFixed(1)}m`, leftX, 75);
                }
                
                // å³å´
                const rightX = padding + 30 * xScale;
                if (structureInfo.details.cutting_side === 'right') {
                    ctx.fillStyle = '#d32f2f';
                    ctx.font = 'bold 14px Arial';
                    ctx.fillText('åˆ‡åœŸ', rightX, 60);
                    ctx.font = '12px Arial';
                    ctx.fillText(`é«˜ã•: ${structureInfo.details.cutting_height.toFixed(1)}m`, rightX, 75);
                } else {
                    ctx.fillStyle = '#388e3c';
                    ctx.font = 'bold 14px Arial';
                    ctx.fillText('ç››åœŸ', rightX, 60);
                    ctx.font = '12px Arial';
                    ctx.fillText(`é«˜ã•: ${structureInfo.details.embankment_height.toFixed(1)}m`, rightX, 75);
                }
            } else if (structureInfo.type === 'cutting') {
                // ä¸¡åˆ‡åœŸã®é«˜ã•è¡¨ç¤º
                ctx.fillStyle = '#d32f2f';
                ctx.font = '14px Arial';
                ctx.fillText(`åˆ‡åœŸé«˜: ${(structureInfo.details.depth || 0).toFixed(1)}m`, centerX, 60);
                
                // å·¦å³ã®è©³ç´°
                if (structureInfo.details.left_cutting_height !== undefined) {
                    ctx.font = '12px Arial';
                    ctx.fillText(`å·¦: ${structureInfo.details.left_cutting_height.toFixed(1)}m`, 
                                padding + 10 * xScale, 75);
                    ctx.fillText(`å³: ${structureInfo.details.right_cutting_height.toFixed(1)}m`, 
                                padding + 30 * xScale, 75);
                }
            } else if (structureInfo.type === 'embankment') {
                // ç´”ç››åœŸã®é«˜ã•è¡¨ç¤º
                ctx.fillStyle = '#388e3c';
                ctx.font = '14px Arial';
                ctx.fillText(`ç››åœŸé«˜: ${(structureInfo.details.height || 0).toFixed(1)}m`, centerX, 60);
                
                // å·¦å³ã®è©³ç´°
                if (structureInfo.details.left_embankment_height !== undefined) {
                    ctx.font = '12px Arial';
                    ctx.fillText(`å·¦: ${structureInfo.details.left_embankment_height.toFixed(1)}m`, 
                                padding + 10 * xScale, 75);
                    ctx.fillText(`å³: ${structureInfo.details.right_embankment_height.toFixed(1)}m`, 
                                padding + 30 * xScale, 75);
                }
            }
            
            // ç·šè·¯æ¨™é«˜ã®è¡¨ç¤º
            ctx.fillStyle = '#f44336';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`ç·šè·¯: ${points[5].elevation.toFixed(1)}m`, centerX + 20, centerY + 5);
            
            // æ–¹å‘ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('â† å·¦', padding + 5 * xScale, 25);
            ctx.fillText('å³ â†’', padding + 35 * xScale, 25);
            
            // è¦–ç‚¹èª¬æ˜
            ctx.fillStyle = '#999';
            ctx.font = '11px Arial';
            ctx.textAlign = 'right';
            ctx.fillText('â€»èµ·ç‚¹æ–¹ã‹ã‚‰çµ‚ç‚¹æ–¹ã‚’è¦‹ãŸæ¨ªæ–­é¢', canvas.width - padding, padding - 5);
            
            // å‹¾é…è¡¨ç¤ºï¼ˆæ³•é¢ãŒã‚ã‚‹å ´åˆï¼‰
            if (structureInfo.details && structureInfo.details.leftSlope) {
                const leftIdx = 3;
                const leftX = padding + (points[leftIdx].distance + 20) * xScale;
                const leftY = canvas.height - padding - (points[leftIdx].elevation - minElevGrid) * yScale;
                
                ctx.fillStyle = '#666';
                ctx.font = '11px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${structureInfo.details.leftSlope}Â°`, leftX, leftY - 10);
            }
            
            if (structureInfo.details && structureInfo.details.rightSlope) {
                const rightIdx = 7;
                const rightX = padding + (points[rightIdx].distance + 20) * xScale;
                const rightY = canvas.height - padding - (points[rightIdx].elevation - minElevGrid) * yScale;
                
                ctx.fillStyle = '#666';
                ctx.font = '11px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${structureInfo.details.rightSlope}Â°`, rightX, rightY - 10);
            }
        }
        
        // æ§‹é€ ç‰©ã‚¿ã‚¤ãƒ—ã®æ—¥æœ¬èªå¤‰æ›
        function getStructureTypeJa(type) {
            const types = {
                'embankment': 'ç´”ç››åœŸ',
                'cutting': 'ä¸¡åˆ‡åœŸ',
                'sidehill': 'ç‰‡åˆ‡ç‰‡ç››',
                'at-grade': 'å¹³åœ°'
            };
            return types[type] || type;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // åˆæœŸè¡¨ç¤ºç”¨ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
        function initializeDisplay() {
            const canvas = document.getElementById('crossSectionCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#999';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('è©•ä¾¡ã‚’å®Ÿè¡Œã™ã‚‹ã¨æ¨ªæ–­é¢å›³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™', canvas.width / 2, canvas.height / 2);
        }

        // ========== AIè§£èª¬æ©Ÿèƒ½ ==========
        
        // 1. ãƒ¡ã‚¤ãƒ³ã®AIè§£èª¬ç”Ÿæˆé–¢æ•°
        async function generateAIReport() {
            if (!currentRailwayData || !currentTerrainData) {
                alert('å…ˆã«å¥å…¨åº¦è©•ä¾¡ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
                return;
            }
            
            const aiLoading = document.getElementById('aiLoading');
            const aiContent = document.getElementById('aiContent');
            
            aiLoading.style.display = 'block';
            aiContent.innerHTML = '';
            
            try {
                let commentary;
                
                // APIä½¿ç”¨ãƒ¢ãƒ¼ãƒ‰ã‹åˆ¤å®š
                if (AI_CONFIG.useAPI && AI_CONFIG.apiKey) {
                    console.log('OpenAI APIãƒ¢ãƒ¼ãƒ‰ã§ç”Ÿæˆ');
                    commentary = await generateWithOpenAI(currentRailwayData, currentTerrainData);
                } else {
                    console.log('ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§ç”Ÿæˆ');
                    commentary = await generateWithRules(currentRailwayData, currentTerrainData);
                }
                
                aiLoading.style.display = 'none';
                aiContent.innerHTML = commentary;
                
            } catch (error) {
                aiLoading.style.display = 'none';
                aiContent.innerHTML = '<p style="color: red;">è§£æã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }
        
        // 2. ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ç”Ÿæˆï¼ˆç¶­æŒç®¡ç†æ¨™æº–æº–æ‹ ï¼‰
        async function generateWithRules(railwayData, terrainData) {
            const structureType = railwayData.structure_analysis.type;
            const structureTypeJa = MAINTENANCE_STANDARD.structures[structureType] || railwayData.structure_analysis.type_ja;
            const healthGrade = railwayData.health_assessment.health_grade;
            const healthInfo = MAINTENANCE_STANDARD.healthGrades[healthGrade];
            
            let html = '<div class="ai-report" style="font-size: 14px; line-height: 1.8;">';
            
            // ã‚¿ã‚¤ãƒˆãƒ«
            html += '<h3 style="text-align: center; color: #2a5298; margin-bottom: 20px;">åœŸæ§‹é€ ç‰©å¥å…¨åº¦è©•ä¾¡å ±å‘Šæ›¸</h3>';
            
            // 1. åŸºæœ¬æƒ…å ±
            html += '<div class="section" style="margin-bottom: 20px;">';
            html += '<h4 style="color: #2a5298; border-bottom: 2px solid #2a5298; padding-bottom: 5px;">1. è©•ä¾¡å¯¾è±¡æ§‹é€ ç‰©</h4>';
            html += '<table style="width: 100%; margin-top: 10px;">';
            html += `<tr><td style="width: 30%; padding: 5px;">æ§‹é€ ç‰©ç¨®åˆ¥ï¼š</td><td><strong>${structureTypeJa}</strong></td></tr>`;
            html += `<tr><td style="padding: 5px;">ä½ç½®ï¼š</td><td>åŒ—ç·¯ ${railwayData.location.latitude}Â°ã€æ±çµŒ ${railwayData.location.longitude}Â°</td></tr>`;
            html += `<tr><td style="padding: 5px;">æ¨™é«˜ï¼š</td><td>${railwayData.location.elevation}</td></tr>`;
            html += '</table>';
            html += '</div>';
            
            // 2. å¥å…¨åº¦åˆ¤å®š
            html += '<div class="section" style="margin-bottom: 20px;">';
            html += '<h4 style="color: #2a5298; border-bottom: 2px solid #2a5298; padding-bottom: 5px;">2. å¥å…¨åº¦åˆ¤å®šçµæœ</h4>';
            html += '<div style="background: #f5f5f5; padding: 15px; margin-top: 10px; border-radius: 5px;">';
            html += `<p style="font-size: 18px; margin: 0;">å¥å…¨åº¦ãƒ©ãƒ³ã‚¯ï¼š<span style="font-size: 24px; font-weight: bold; color: ${getGradeColor(healthGrade)};">${healthGrade}</span>ï¼ˆ${healthInfo.description}ï¼‰</p>`;
            html += `<p style="margin: 10px 0 0 0; color: #666;">${healthInfo.detail}</p>`;
            html += '</div>';
            html += '</div>';
            
            // 3. ä¸»ãªå¤‰çŠ¶
            if (railwayData.health_assessment.main_risks.length > 0) {
                html += '<div class="section" style="margin-bottom: 20px;">';
                html += '<h4 style="color: #2a5298; border-bottom: 2px solid #2a5298; padding-bottom: 5px;">3. ç¢ºèªã•ã‚ŒãŸä¸»ãªå¤‰çŠ¶</h4>';
                html += '<ul style="margin-top: 10px;">';
                railwayData.health_assessment.main_risks.forEach(risk => {
                    html += `<li style="margin-bottom: 5px;">${risk}</li>`;
                });
                html += '</ul>';
                html += '</div>';
            }
            
            // 4. é›†æ°´ç‰¹æ€§è©•ä¾¡
            html += '<div class="section" style="margin-bottom: 20px;">';
            html += '<h4 style="color: #2a5298; border-bottom: 2px solid #2a5298; padding-bottom: 5px;">4. é›†æ°´ç‰¹æ€§è©•ä¾¡</h4>';
            
            if (railwayData.drainage_impact.has_zero_order_basin) {
                html += '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin: 10px 0;">';
                html += '<strong>âš ï¸ 0æ¬¡è°·æ¤œå‡º</strong><br>';
                html += 'åœ°å½¢çš„ã«è¡¨æµæ°´ãŒé›†ä¸­ã—ã‚„ã™ã„ç®‡æ‰€ã§ã™ã€‚é›†ä¸­è±ªé›¨æ™‚ã®å±€æ‰€çš„ãªå‡ºæ°´ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚';
                html += '</div>';
            }
            
            html += `<p>é›†æ°´é¢ç©è¦æ¨¡ï¼š${railwayData.drainage_impact.catchment_area}</p>`;
            html += `<p>ä¸»è¦é›†æ°´æ–¹å‘ï¼š${railwayData.drainage_impact.impact_pattern}</p>`;
            html += '</div>';
            
            // 5. ç¶­æŒç®¡ç†ä¸Šã®ç•™æ„ç‚¹
            html += '<div class="section" style="margin-bottom: 20px;">';
            html += '<h4 style="color: #2a5298; border-bottom: 2px solid #2a5298; padding-bottom: 5px;">5. ç¶­æŒç®¡ç†ä¸Šã®ç•™æ„ç‚¹</h4>';
            html += '<p style="margin-top: 10px;">æ¤œæŸ»å‘¨æœŸï¼š' + MAINTENANCE_STANDARD.inspectionCycles[healthGrade] + '</p>';
            
            // ç›£è¦–ãƒã‚¤ãƒ³ãƒˆ
            if (railwayData.recommendations.monitoring_points.length > 0) {
                html += '<p style="margin-top: 10px;"><strong>é‡ç‚¹ç›£è¦–é …ç›®ï¼š</strong></p>';
                html += '<ul>';
                railwayData.recommendations.monitoring_points.forEach(point => {
                    html += `<li style="margin-bottom: 5px;">${point}</li>`;
                });
                html += '</ul>';
            }
            html += '</div>';
            
            // 6. æ¨å¥¨æªç½®
            html += '<div class="section" style="margin-bottom: 20px;">';
            html += '<h4 style="color: #2a5298; border-bottom: 2px solid #2a5298; padding-bottom: 5px;">6. æ¨å¥¨ã•ã‚Œã‚‹æªç½®</h4>';
            
            // å¥å…¨åº¦ã«å¿œã˜ãŸæªç½®
            if (healthGrade === 'AA') {
                html += '<p style="color: #d32f2f;"><strong>ç·Šæ€¥æªç½®ãŒå¿…è¦ã§ã™ã€‚</strong></p>';
            } else if (healthGrade === 'A' || healthGrade === 'B') {
                html += '<p>è¨ˆç”»çš„ãª' + MAINTENANCE_STANDARD.measures.maintenance + 'ã¾ãŸã¯' + 
                        MAINTENANCE_STANDARD.measures.reinforcement + 'ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚</p>';
            } else if (healthGrade === 'C') {
                html += '<p>ç¶™ç¶šçš„ãª' + MAINTENANCE_STANDARD.measures.monitoring + 'ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚</p>';
            }
            
            html += '</div>';
            
            // è©•ä¾¡æ—¥æ™‚
            const now = new Date();
            html += '<p style="text-align: right; color: #666; font-size: 12px; margin-top: 30px;">';
            html += `è©•ä¾¡å®Ÿæ–½æ—¥æ™‚ï¼š${now.toLocaleString('ja-JP')}<br>`;
            html += 'è©•ä¾¡æ–¹æ³•ï¼šç¶­æŒç®¡ç†æ¨™æº–æº–æ‹ ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹';
            html += '</p>';
            
            html += '</div>';
            
            return html;
        }
        
        // 3. OpenAI APIç‰ˆ
        async function generateWithOpenAI(railwayData, terrainData) {
            const systemPrompt = `ã‚ãªãŸã¯é‰„é“åœŸæ§‹é€ ç‰©ã®ç¶­æŒç®¡ç†å°‚é–€å®¶ã§ã™ã€‚
é‰„é“æ§‹é€ ç‰©ç­‰ç¶­æŒç®¡ç†æ¨™æº–ï¼ˆåœŸæ§‹é€ ç‰©ï¼‰ã«å®Œå…¨æº–æ‹ ã—ã¦è©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ä½¿ç”¨ã™ã‚‹ç”¨èªï¼š
- æ§‹é€ ç‰©ç¨®åˆ¥ï¼šåˆ‡åœŸã€ç››åœŸã€ç‰‡åˆ‡ç‰‡ç››ã€è‡ªç„¶æ–œé¢
- å¥å…¨åº¦ï¼šSï¼ˆå¥å…¨ï¼‰ã€Aãƒ»Bãƒ»Cï¼ˆè¦æ³¨æ„ï¼‰ã€AAï¼ˆè¦æªç½®ï¼‰
- å¤‰çŠ¶ç¨®åˆ¥ï¼šä»˜è¡¨3-2ã«æº–æ‹ 
- æªç½®ï¼šç›£è¦–ã€è£œä¿®ã€è£œå¼·ã€æ”¹ç¯‰ãƒ»å–æ›¿

ãƒ¬ãƒãƒ¼ãƒˆå½¢å¼ï¼š
1. è©•ä¾¡å¯¾è±¡æ§‹é€ ç‰©
2. å¥å…¨åº¦åˆ¤å®šçµæœ
3. ç¢ºèªã•ã‚ŒãŸä¸»ãªå¤‰çŠ¶
4. é›†æ°´ç‰¹æ€§è©•ä¾¡
5. ç¶­æŒç®¡ç†ä¸Šã®ç•™æ„ç‚¹
6. æ¨å¥¨ã•ã‚Œã‚‹æªç½®`;

            const userPrompt = `ä»¥ä¸‹ã®è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç¶­æŒç®¡ç†æ¨™æº–æº–æ‹ ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

æ§‹é€ ç‰©ï¼š${railwayData.structure_analysis.type_ja}
å¥å…¨åº¦ï¼š${railwayData.health_assessment.health_grade}
ã‚¹ã‚³ã‚¢ï¼š${railwayData.health_assessment.overall_score}/100
ä½ç½®ï¼š${railwayData.location.latitude}, ${railwayData.location.longitude}
æ¨™é«˜ï¼š${railwayData.location.elevation}

ä¸»ãªå¤‰çŠ¶ï¼š
${railwayData.health_assessment.main_risks.join('\n')}

é›†æ°´ç‰¹æ€§ï¼š
- 0æ¬¡è°·ï¼š${railwayData.drainage_impact.has_zero_order_basin ? 'æ¤œå‡º' : 'ãªã—'}
- é›†æ°´é¢ç©ï¼š${railwayData.drainage_impact.catchment_area}
- é›†æ°´ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š${railwayData.drainage_impact.impact_pattern}

åœ°è³ªï¼š${railwayData.geology_assessment.rock_type}
åœ°è³ªãƒªã‚¹ã‚¯ï¼š${railwayData.geology_assessment.risk_level}

ç›£è¦–ãƒã‚¤ãƒ³ãƒˆï¼š
${railwayData.recommendations.monitoring_points.join('\n')}`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AI_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: AI_CONFIG.model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        temperature: 0.3,
                        max_tokens: 1500
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed: ' + response.statusText);
                }
                
                const data = await response.json();
                let aiResponse = data.choices[0].message.content;
                
                // HTMLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                aiResponse = aiResponse.replace(/\n/g, '<br>');
                aiResponse = aiResponse.replace(/##\s*(.+)/g, '<h4 style="color: #2a5298; margin: 15px 0 10px 0;">$1</h4>');
                aiResponse = aiResponse.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                
                // ãƒ©ãƒƒãƒ‘ãƒ¼ã¨ãƒ•ãƒƒã‚¿ãƒ¼è¿½åŠ 
                return `<div class="ai-report" style="font-size: 14px; line-height: 1.8;">
                    ${aiResponse}
                    <p style="text-align: right; color: #666; font-size: 12px; margin-top: 30px;">
                        è©•ä¾¡å®Ÿæ–½æ—¥æ™‚ï¼š${new Date().toLocaleString('ja-JP')}<br>
                        è©•ä¾¡æ–¹æ³•ï¼šOpenAI ${AI_CONFIG.model} (ç¶­æŒç®¡ç†æ¨™æº–æº–æ‹ )
                    </p>
                </div>`;
                
            } catch (error) {
                console.error('OpenAI API Error:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                return await generateWithRules(railwayData, terrainData);
            }
        }
        
        // 4. å¥å…¨åº¦ã®è‰²ã‚’å–å¾—
        function getGradeColor(grade) {
            const colors = {
                'S': '#4CAF50',
                'A': '#FFC107',
                'B': '#FF9800',
                'C': '#f57c00',
                'AA': '#f44336'
            };
            return colors[grade] || '#666';
        }
        
        // 5. UIåˆ¶å¾¡é–¢æ•°
        function toggleAIMode() {
            const useAI = document.getElementById('useAI').checked;
            const apiKeyInput = document.getElementById('apiKey');
            
            if (useAI) {
                apiKeyInput.style.display = 'inline';
                AI_CONFIG.useAPI = true;
            } else {
                apiKeyInput.style.display = 'none';
                AI_CONFIG.useAPI = false;
            }
        }
        
        // ========== AIè§£èª¬æ©Ÿèƒ½ã“ã“ã¾ã§ ==========
        
        // Enterã‚­ãƒ¼ã§ã‚‚å®Ÿè¡Œ
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeRailway();
            }
        });

                // â†“â†“â†“ ã¿ãï¼šã“ã‚Œã‚’è¿½åŠ  â†“â†“â†“
        
        // APIã‚­ãƒ¼å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
        window.addEventListener('DOMContentLoaded', function() {
            const apiKeyInput = document.getElementById('apiKey');
            if (apiKeyInput) {
                apiKeyInput.addEventListener('change', function() {
                    AI_CONFIG.apiKey = this.value;
                });
            }
        });
        
        // â­ Phase 2: åœ°å½¢ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†ææ©Ÿèƒ½
        async function runGeomorphologyAnalysis() {
            console.log('ğŸ”ï¸ åœ°å½¢åˆ†æé–‹å§‹ï¼');
            
            // â­ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼
            console.log('currentRailwayData:', currentRailwayData);
            console.log('currentTerrainData:', currentTerrainData);
            
            if (!currentRailwayData || !currentTerrainData) {
                alert('å…ˆã«å¥å…¨åº¦è©•ä¾¡ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼');
                return;
            }
            
            const analyzer = new GeomorphologyAnalyzer();
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            
            // â­ ã“ã“ã‚‚ç¢ºèªï¼
            console.log('æ¸¡ã™ãƒ‡ãƒ¼ã‚¿:', {
                lat: lat,
                lon: lon,
                railwayData: currentRailwayData,
                terrainData: currentTerrainData
            });
            
            const resultDiv = document.getElementById('geomorphology-result');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p style="color: #6366f1; font-weight: bold; margin-top: 15px;">
                        ğŸ” åˆ†æä¸­... ã¿ããŒåœ°å½¢ãƒ‡ãƒ¼ã‚¿ã‚’è§£æã—ã¦ã‚‹ã‚ˆï¼
                    </p>
                </div>
            `;
            
            try {
                // æ‹¡å¼µç‰ˆã®analyzeContextã‚’å‘¼ã³å‡ºã—
                const report = await analyzer.analyzeContext(
                    lat, 
                    lon, 
                    currentRailwayData,  // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™
                    currentTerrainData   // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™
                );
                
                // HTMLå½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ãã®ã¾ã¾è¡¨ç¤º
                resultDiv.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 8px;
                        padding: 20px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    ">
                        ${report}
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="
                        background: #fee;
                        border: 1px solid #fcc;
                        border-radius: 8px;
                        padding: 15px;
                        color: #c33;
                    ">
                        <p><strong>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ ğŸ˜¢</strong></p>
                        <p style="font-size: 14px; margin-top: 5px;">
                            ${error.message}
                        </p>
                    </div>
                `;
                console.error('åœ°å½¢è§£æã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // â­ Phase 3: é›†æ°´åœ°å½¢è§£ææ©Ÿèƒ½
        async function runCatchmentAnalysis() {
            console.log('ğŸ’§ é›†æ°´åœ°å½¢è§£æé–‹å§‹ï¼');
            
            if (!currentRailwayData || !currentTerrainData) {
                alert('å…ˆã«å¥å…¨åº¦è©•ä¾¡ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼');
                return;
            }
            
            const analyzer = new CatchmentAnalyzer();
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            
            const resultDiv = document.getElementById('catchment-result');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p style="color: #2196F3; font-weight: bold; margin-top: 15px;">
                        ğŸ” è§£æä¸­... ã¿ããŒé›†æ°´åœ°å½¢ã‚’åˆ†æã—ã¦ã‚‹ã‚ˆï¼
                    </p>
                </div>
            `;
            
            try {
    // é›†æ°´åœ°å½¢è§£æå®Ÿè¡Œ
    const result = await analyzer.analyzeCatchmentFeatures(lat, lon);
    
    // â­ ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šçµæœã®å½¢å¼ã‚’ç¢ºèªï¼
    console.log('è§£æçµæœ:', result);
    
    // çµæœãŒæ­£ã—ãè¿”ã£ã¦ãã¦ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (!result) {
        throw new Error('è§£æçµæœãŒç©ºã§ã™');
    }
    
    // çµæœè¡¨ç¤ºHTMLä½œæˆï¼ˆå®‰å…¨ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼‰
    let html = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h4 style="color: #1976D2; margin-bottom: 10px;">ğŸ”ï¸ è°·åœ°å½¢æ¤œå‡ºçµæœ</h4>
                <p><strong>æ¤œå‡ºè°·æ•°:</strong> ${result.valleyFeatures ? result.valleyFeatures.length : 0}ç®‡æ‰€</p>
                <p><strong>0æ¬¡è°·:</strong> ${result.hasZeroOrderValley ? 'æ¤œå‡ºã‚ã‚Šâš ï¸' : 'ãªã—'}</p>
                <p><strong>æœ€è¿‘æ¥è°·:</strong> ${result.nearestValleyDistance ? result.nearestValleyDistance.toFixed(0) : '---'}m</p>
            </div>
            <div>
                <h4 style="color: #1976D2; margin-bottom: 10px;">ğŸ’§ é›†æ°´å½±éŸ¿è©•ä¾¡</h4>
                <p><strong>å½±éŸ¿åº¦:</strong> <span style="
                    font-size: 20px; 
                    font-weight: bold; 
                    color: ${result.overallRisk > 70 ? '#d32f2f' : result.overallRisk > 40 ? '#f57c00' : '#388e3c'};
                ">${result.impactLevel || '---'}</span></p>
                <p><strong>ã‚¹ã‚³ã‚¢:</strong> ${result.overallRisk || 0}/100</p>
                <p><strong>ä¸»è¦é›†æ°´æ–¹å‘:</strong> ${result.dominantFlowDirection || '---'}</p>
            </div>
        </div>
            
    <!-- â­ å½±éŸ¿åº¦ã‚¹ã‚³ã‚¢ã®å‡¡ä¾‹ã‚’è¿½åŠ ï¼ -->
    <div style="
        margin-top: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 8px;
        border-left: 4px solid #2196F3;
    ">
        <h5 style="margin: 0 0 10px 0; color: #1976D2;">ğŸ“Š å½±éŸ¿åº¦ã‚¹ã‚³ã‚¢ã®è¦‹æ–¹</h5>
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; text-align: center;">
            <div style="padding: 5px; background: #e8f5e9; border-radius: 4px;">
                <div style="font-weight: bold; color: #388e3c;">0-20</div>
                <div style="font-size: 12px;">æ¥µä½</div>
            </div>
            <div style="padding: 5px; background: #fff3e0; border-radius: 4px;">
                <div style="font-weight: bold; color: #f57c00;">21-40</div>
                <div style="font-size: 12px;">ä½</div>
            </div>
            <div style="padding: 5px; background: #fff3e0; border-radius: 4px;">
                <div style="font-weight: bold; color: #f57c00;">41-60</div>
                <div style="font-size: 12px;">ä¸­</div>
            </div>
            <div style="padding: 5px; background: #ffebee; border-radius: 4px;">
                <div style="font-weight: bold; color: #d32f2f;">61-80</div>
                <div style="font-size: 12px;">é«˜</div>
            </div>
            <div style="padding: 5px; background: #ffebee; border-radius: 4px;">
                <div style="font-weight: bold; color: #b71c1c;">81-100</div>
                <div style="font-size: 12px;">æ¥µé«˜</div>
            </div>
        </div>
        <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">
            â€» åŒ—ä¹…é‡Œæµœé§…ï¼ˆéƒ½å¸‚éƒ¨ï¼‰ã®ã‚¹ã‚³ã‚¢4ã¯ã€Œæ¥µä½ã€ã§å¦¥å½“ã§ã™
        </p>
    </div>
    `;
                
                // æ¨å¥¨äº‹é …ãŒã‚ã‚Œã°è¡¨ç¤º
                if (result.recommendations && result.recommendations.length > 0) {
                    html += `
                        <div style="margin-top: 20px;">
                            <h4 style="color: #1976D2;">ğŸ“ æ¨å¥¨äº‹é …</h4>
                            <ul style="margin: 10px 0;">
                    `;
                    result.recommendations.forEach(rec => {
                        html += `<li style="margin-bottom: 5px;">${rec}</li>`;
                    });
                    html += `</ul></div>`;
                }
                
                // åœ°å›³è¡¨ç¤ºãƒœã‚¿ãƒ³
                html += `
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="showCatchmentMap()" style="
                            padding: 10px 30px;
                            background: #1976D2;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                        ">
                            ğŸ“ è©³ç´°åœ°å›³ã‚’è¡¨ç¤º
                        </button>
                    </div>
                `;
                
                resultDiv.innerHTML = html;
                
                // è§£æçµæœã‚’ä¿å­˜
                window.currentCatchmentResult = result;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="
                        background: #fee;
                        border: 1px solid #fcc;
                        border-radius: 8px;
                        padding: 15px;
                        color: #c33;
                    ">
                        <p><strong>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ ğŸ˜¢</strong></p>
                        <p style="font-size: 14px; margin-top: 5px;">
                            ${error.message}
                        </p>
                    </div>
                `;
                console.error('é›†æ°´åœ°å½¢è§£æã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // åœ°å›³è¡¨ç¤ºé–¢æ•°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ç‰ˆï¼‰
        function showCatchmentMap() {
            // ã¿ãï¼šå¾Œã§å®Ÿè£…ã™ã‚‹ã‘ã‚“ï¼
            alert('åœ°å›³è¡¨ç¤ºæ©Ÿèƒ½ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè£…ã™ã‚‹ã°ã„ï¼ğŸ’•');
        }        
        
    </script>
</body>
</html>